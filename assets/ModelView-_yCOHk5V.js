import{r as l,j as e,b2 as L,at as T,m as z}from"./index-BYXjn4hA.js";import{m as O,f as P,n as H,r as D,o as V,p as B,q as W}from"./v2Api-zEssVn_2.js";import{u as J,c as Z,d as Q,i as X,a as K,M as U,C as Y}from"./style-D9jK736I.js";import{P as ee}from"./plus-Db2s5bXk.js";import{C as te}from"./circle-x-DGeOmOLa.js";import"./value-NzwA106W.js";const se=[{id:"req_semantics",name:"Rich Semantics",rationale:"LLMs need context to understand data.",signalTypesRequired:["SEMANTICS"]},{id:"req_lineage",name:"Traceability",rationale:"Need to trace source of truth.",signalTypesRequired:["LINEAGE"]}],ae=[{id:"req_semantics",name:"Rich Semantics",rationale:"Agents need descriptions to select tools.",signalTypesRequired:["SEMANTICS"]},{id:"req_quality",name:"High Quality",rationale:"Agents act on data; it must be reliable.",signalTypesRequired:["FRESHNESS","OWNERSHIP"]}],ie=[{id:"req_owner",name:"Clear Ownership",rationale:"Every asset needs an owner.",signalTypesRequired:["OWNERSHIP"]}],re=[{id:"req_lineage_depth",name:"End-to-End Lineage",rationale:"Impact analysis requires full lineage.",signalTypesRequired:["LINEAGE"]}],le={ai_rag:se,ai_agent:ae,data_ownership:ie,data_lineage:re},de=s=>s.map((a,n)=>({id:a.id,position:a.position??{x:n%4*220,y:Math.floor(n/4)*140},data:{label:a.name||a.id,type:a.type},style:{borderRadius:10,border:"1px solid #E2E8F0",padding:10,background:"#FFFFFF",color:"#0F172A",fontSize:12,fontWeight:600}})),ne=s=>s.map((a,n)=>({id:a.id??`edge-${a.source}-${a.target}-${n}`,source:a.source,target:a.target,label:a.label,animated:!1,style:{stroke:"#94A3B8"}}));function oe({graph:s}){const a=l.useMemo(()=>de(s.nodes||[]),[s.nodes]),n=l.useMemo(()=>ne(s.edges||[]),[s.edges]),[h,o,y]=J(a),[p,i,g]=Z(n);l.useEffect(()=>{o(a),i(n)},[n,a,i,o]);const b=l.useCallback(c=>{i(m=>Q({...c,type:"smoothstep",animated:!0},m))},[i]);return h.length?e.jsx("div",{className:"h-[320px] sm:h-[420px] border border-slate-200 rounded-lg bg-slate-50","data-testid":"modeler-canvas",children:e.jsxs(X,{nodes:h,edges:p,onNodesChange:y,onEdgesChange:g,onConnect:b,fitView:!0,minZoom:.2,maxZoom:1.5,nodesDraggable:!0,children:[e.jsx(K,{gap:16,size:1}),e.jsx(U,{pannable:!0,zoomable:!0}),e.jsx(Y,{})]})}):e.jsx("div",{className:"border border-dashed border-slate-300 rounded-lg p-6 text-sm text-slate-500 bg-slate-50",children:"Add entities to see them in the visual modeler."})}const q=Object.values(le).flat();function ge(){const{run:s}=L(),[a,n]=l.useState(null),[h,o]=l.useState(!1),[y,p]=l.useState([]),[i,g]=l.useState(null),[b,c]=l.useState(!1),[m,w]=l.useState(""),[E,C]=l.useState("Entity"),[f,j]=l.useState([]),[N,S]=l.useState(!1),x=l.useMemo(()=>{const t=new Map;return f.forEach(r=>{if(r.subjectType==="MODEL_ELEMENT"&&r.subjectId){const d=r.subjectId;t.has(d)||t.set(d,[]),t.get(d).push(r)}}),t},[f]);l.useEffect(()=>{s?.id&&(u(),F(),M())},[s?.id]);const F=async()=>{try{const t=await fetch("/api/runs/templates");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=await t.json();p(Array.isArray(r)?r:[])}catch(t){console.error("Failed to fetch templates:",t),p([])}},u=async()=>{if(s?.id){o(!0);try{const t=await O(s.id);n(t)}catch(t){console.error(t)}finally{o(!1)}}},M=async()=>{if(s?.id)try{const t=await P(s.id);j(Array.isArray(t)?t:[])}catch(t){console.error("Failed to fetch gaps:",t),j([])}},A=async()=>{if(s?.id){S(!0);try{const t=await D(s.id);j(t.gaps||[]),alert(`Gaps recomputed! Found ${t.count} gaps.`)}catch{alert("Failed to recompute gaps")}finally{S(!1)}}},k=async t=>{if(s?.id){o(!0);try{await H(s.id,t),await u()}catch{alert("Failed to create model")}finally{o(!1)}}},I=async(t,r,d)=>{if(!s?.id)return;const G=d.includes(r)?d.filter(R=>R!==r):[...d,r];try{await W(s.id,t,G),await u()}catch{alert("Failed to update requirements")}},_=async()=>{if(!(!s?.id||!m.trim()))try{await V(s.id,{name:m,type:E,requirementIds:[]}),await u(),c(!1),w(""),C("Entity")}catch{alert("Failed to add entity")}},$=async t=>{if(s?.id&&confirm("Remove this entity from the model?"))try{await B(s.id,t),await u(),i?.id===t&&g(null)}catch{alert("Failed to remove entity")}};if(!s)return null;if(h&&!a)return e.jsx("div",{className:"p-8",children:e.jsx(T,{className:"animate-spin"})});if(!a)return e.jsxs("div",{className:"p-4 sm:p-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Create Logical Model"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Start from a template to define your metadata requirements."}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl",children:y.map(t=>e.jsxs("button",{onClick:()=>k(t.id),className:"bg-white border border-gray-300 p-4 rounded-lg hover:border-blue-500 hover:shadow-md transition","aria-label":`Create model from ${t.name}`,"data-testid":`model-template-${t.id}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name}),t.description&&e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:t.description})]},t.id))})]});let v={nodes:[],edges:[]};try{v=JSON.parse(a.graphJson)}catch(t){console.error("Failed to parse model graph:",t)}return e.jsxs("div",{className:"p-4 sm:p-8 h-full flex flex-col",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:a.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Version ",a.version," â€¢ ",f.length," gaps detected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:A,disabled:N,className:"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50","aria-disabled":N,"aria-label":"Recompute gaps",children:[N?e.jsx(T,{size:16,className:"animate-spin"}):e.jsx(z,{size:16}),"Recompute Gaps"]}),e.jsxs("button",{onClick:()=>c(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700","aria-label":"Add entity",children:[e.jsx(ee,{size:16})," Add Entity"]})]})]}),b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-[90vw] max-w-md",role:"dialog","aria-modal":"true","aria-labelledby":"add-entity-title","data-testid":"add-entity-modal",children:[e.jsx("h3",{id:"add-entity-title",className:"text-lg font-bold mb-4",children:"Add New Entity"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-entity-name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{id:"new-entity-name",type:"text",value:m,onChange:t=>w(t.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2",placeholder:"e.g., Customer"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-entity-type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Type"}),e.jsxs("select",{id:"new-entity-type",value:E,onChange:t=>C(t.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2",children:[e.jsx("option",{value:"Entity",children:"Entity"}),e.jsx("option",{value:"Concept",children:"Concept"})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>c(!1),type:"button",className:"px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md",children:"Cancel"}),e.jsx("button",{onClick:_,type:"button",className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Save"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 flex-1",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4","aria-label":"Entity list","data-testid":"entity-list",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Entities"}),e.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-auto",children:v.nodes.map(t=>e.jsxs("button",{onClick:()=>g(t),className:`w-full text-left p-3 rounded border transition ${i?.id===t.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,"aria-pressed":i?.id===t.id,"data-testid":`entity-${t.id}`,children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500",children:t.type}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[(t.requirementIds||[]).length," requirements"]}),x.has(t.id)&&e.jsxs("div",{className:"text-xs text-red-600 mt-1 font-semibold",children:[x.get(t.id).length," gap",x.get(t.id).length!==1?"s":""]})]},t.id))})]}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 lg:col-span-2 flex flex-col",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Entity"}),e.jsx("h3",{className:"text-xl font-bold",children:i.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Type: ",i.type]})]}),e.jsxs("button",{onClick:()=>$(i.id),className:"text-red-600 hover:text-red-700 flex items-center gap-2","aria-label":`Remove ${i.name}`,children:[e.jsx(te,{size:18})," Remove"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800 mb-1",children:"Attached Requirements"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(i.requirementIds||[]).map(t=>{const r=q.find(d=>d.id===t);return r?e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold",children:r.name},t):null}),(i.requirementIds||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-500",children:"No requirements attached"})]})]}),x.has(i.id)&&e.jsxs("div",{className:"mb-3 border-t pt-3",children:[e.jsx("div",{className:"text-sm font-semibold text-red-800 mb-2",children:"Gaps for this entity"}),e.jsx("div",{className:"space-y-2",children:x.get(i.id).map(t=>e.jsxs("div",{className:"border border-red-200 bg-red-50 rounded p-2",children:[e.jsx("div",{className:"text-xs font-semibold text-red-900",children:t.gapType}),e.jsx("div",{className:"text-xs text-red-700 mt-1",children:t.explanation}),t.severity&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["Severity: ",t.severity]})]},t.id))})]}),e.jsxs("div",{className:"flex-1 overflow-auto",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-800 mb-2",children:"Toggle Requirements"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:q.map(t=>{const r=(i.requirementIds||[]).includes(t.id);return e.jsxs("label",{className:`border rounded-lg p-3 cursor-pointer transition block ${r?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-400"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500",children:t.rationale})]}),e.jsx("input",{type:"checkbox",checked:r,onChange:()=>I(i.id,t.id,i.requirementIds||[]),className:"mt-1","aria-label":`Toggle ${t.name}`})]}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:t.signalTypesRequired.map(d=>e.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-semibold",children:d},d))})]},t.id)})})]})]}):e.jsx("div",{className:"text-gray-500 text-sm",children:"Select an entity to view and edit requirements."})})]}),e.jsxs("div",{className:"mt-6 bg-white border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Visual Modeler"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Drag nodes to adjust layout. Connections update automatically."})]}),e.jsx("span",{className:"text-xs text-slate-400",children:"Powered by React Flow"})]}),e.jsx(oe,{graph:v})]})]})}export{ge as ModelView};
