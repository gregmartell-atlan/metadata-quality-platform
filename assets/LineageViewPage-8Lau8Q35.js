import{c as le,l as V,r as b,j as e,S as oe,m as ce,a4 as de,ab as he,ac as ue,o as G,L as $,E as W,ad as me,D as Y,n as pe,ae as ge,T as fe,F as xe,O as ye,G as je,f as ve,af as we,ag as Ne,ah as be,I as Ce,N as Se}from"./index-BYXjn4hA.js";import{H as _,P as R,g as Me,B as Ee,i as Te,a as ke,C as Ae,M as Ue,b as Pe,R as De}from"./style-D9jK736I.js";import{C as Le}from"./chevron-up-Gnmli0Ka.js";import{C as Ie}from"./circle-x-DGeOmOLa.js";import{A as Be}from"./AppHeader-bBOFCWJR.js";import{H as Ge,a as Z,b as q,c as Re}from"./HeaderActions-DWTmbmyV.js";import{S as Oe}from"./settings-2-CvDn4tF2.js";import{D as Fe}from"./download-DQhb5Itz.js";import"./value-NzwA106W.js";import"./funnel-DPZwMpz0.js";import"./list-k-ASkxhI.js";const ze=[["path",{d:"m16 18 6-6-6-6",key:"eg8j8"}],["path",{d:"m8 6-6 6 6 6",key:"ppft3o"}]],B=le("code",ze);function J(s){return["Process","ColumnProcess","BIProcess","SparkJob"].some(a=>s.includes(a)||s===a)}function X(s){const i=Date.now(),a=s.updateTime||s.sourceUpdatedAt||s.lastSyncRunAt,o=a?Math.floor((i-a)/(1e3*60*60*24)):void 0,c=o!==void 0&&o>90;return{lastUpdated:a,lastSyncRunAt:s.lastSyncRunAt,sourceLastReadAt:s.sourceLastReadAt,updateTime:s.updateTime,isStale:c,stalenessDays:o}}function K(s){return{certificateStatus:s.certificateStatus,ownerUsers:Array.isArray(s.ownerUsers)?s.ownerUsers.map(i=>typeof i=="string"?i:i.name||i.guid):[],ownerGroups:Array.isArray(s.ownerGroups)?s.ownerGroups.map(i=>typeof i=="string"?i:i.name||i.guid):[],tags:s.assetTags||s.classificationNames||[],terms:s.meanings||s.assignedTerms||[],domainGUIDs:s.domainGUIDs||[]}}function qe(s,i,a="both",o){const c=[],m=[],d=i.guidEntityMap||{},f=i.relations||[],l=d[s.guid]||s,x={id:l.guid,guid:l.guid,label:l.name||l.qualifiedName||"Unknown",type:l.typeName||"Unknown",entityType:J(l.typeName||"")?"process":"asset",data:l,hasDescription:!!(s.description||s.userDescription),hasOwner:!!(s.ownerUsers?.length||s.ownerGroups?.length),hasTags:!!(s.assetTags?.length||s.classificationNames?.length),hasTerms:!!(s.meanings?.length||s.assignedTerms?.length),hasCertificate:!!s.certificateStatus,hasUpstream:!1,hasDownstream:!1,upstreamCount:0,downstreamCount:0,isExpandable:!1,isExpanded:!0,isCenterNode:!0,qualityScores:o?.get(s.guid),governance:K(s),freshness:X(s)};c.push(x),Object.values(d).forEach(t=>{if(t.guid===l.guid)return;const M=J(t.typeName||"")?"process":"asset",S={id:t.guid,guid:t.guid,label:t.name||t.qualifiedName||"Unknown",type:t.typeName||"Unknown",entityType:M,data:t,hasDescription:!!(t.description||t.userDescription),hasOwner:!!(t.ownerUsers?.length||t.ownerGroups?.length),hasTags:!!(t.assetTags?.length||t.classificationNames?.length),hasTerms:!!(t.meanings?.length||t.assignedTerms?.length),hasCertificate:!!t.certificateStatus,hasUpstream:!1,hasDownstream:!1,upstreamCount:0,downstreamCount:0,isExpandable:!0,isExpanded:!1,isCenterNode:!1,qualityScores:o?.get(t.guid),governance:K(t),freshness:X(t)};c.push(S)});const w=[];V.debug("[buildLineageGraph] Relations:",f.length,"Nodes:",c.length),f.forEach(t=>{const M=c.find(A=>A.guid===t.fromEntityId),S=c.find(A=>A.guid===t.toEntityId);if(!M||!S)return;const E={id:t.relationshipId||`${t.fromEntityId}-${t.toEntityId}`,source:t.fromEntityId,target:t.toEntityId,relationshipType:t.relationshipType||"unknown",relationshipId:t.relationshipId,isUpstream:!1,sourceType:M.type,targetType:S.type};w.push(E)});const C=new Map,r=new Map;w.forEach(t=>{C.has(t.source)||C.set(t.source,[]),C.get(t.source).push(t),r.has(t.target)||r.set(t.target,[]),r.get(t.target).push(t)});const n=new Set,h=new Set;function N(t,M){if(M.has(t))return;M.add(t),(r.get(t)||[]).forEach(E=>{n.add(E.source),N(E.source,M)})}function u(t,M){if(M.has(t))return;M.add(t),(C.get(t)||[]).forEach(E=>{h.add(E.target),u(E.target,M)})}N(l.guid,new Set),u(l.guid,new Set),w.forEach(t=>{const M=n.has(t.target)&&t.target!==l.guid;h.has(t.source)&&(t.source,l.guid),t.target===l.guid?t.isUpstream=!0:t.source===l.guid?t.isUpstream=!1:t.isUpstream=M}),c.forEach(t=>{t.guid!==l.guid&&(t.hasUpstream=n.has(t.guid),t.hasDownstream=h.has(t.guid),t.upstreamCount=(r.get(t.guid)||[]).length,t.downstreamCount=(C.get(t.guid)||[]).length)}),a==="both"?m.push(...w):a==="upstream"?m.push(...w.filter(t=>t.isUpstream||t.target===l.guid)):a==="downstream"&&m.push(...w.filter(t=>!t.isUpstream||t.source===l.guid));const k=m.filter(t=>t.target===l.guid),j=m.filter(t=>t.source===l.guid);return x.hasUpstream=k.length>0||n.size>0,x.hasDownstream=j.length>0||h.size>0,x.upstreamCount=k.length,x.downstreamCount=j.length,V.debug("[buildLineageGraph] Final graph - nodes:",c.length,"edges:",m.length),{nodes:c,edges:m,centerNodeId:l.guid}}function Qe(s){const{nodes:i}=s,a=i.filter(r=>r.entityType==="asset").length,o=i.filter(r=>r.entityType==="process").length,c=i.length,m=i.filter(r=>r.hasUpstream).length,d=i.filter(r=>r.hasDownstream).length,f=i.filter(r=>r.hasUpstream&&r.hasDownstream).length,l=i.filter(r=>!r.hasUpstream&&!r.hasDownstream).length,x=c>0?Math.round((c-l)/c*100):0,w=c>0?Math.round(i.reduce((r,n)=>r+n.upstreamCount,0)/c*10)/10:0,C=c>0?Math.round(i.reduce((r,n)=>r+n.downstreamCount,0)/c*10)/10:0;return{totalAssets:a,totalProcesses:o,withUpstream:m,withDownstream:d,withFullLineage:f,orphaned:l,coveragePercentage:x,avgUpstreamCount:w,avgDownstreamCount:C}}function He(s){const{nodes:i}=s,a=i.filter(d=>d.qualityScores&&d.entityType==="asset");if(a.length===0)return{avgCompleteness:0,avgAccuracy:0,avgTimeliness:0,avgConsistency:0,avgUsability:0,avgOverall:0,assetsWithIssues:0,assetsWithIssuesPercentage:0};const o=a.reduce((d,f)=>{const l=f.qualityScores;return d.completeness+=l.completeness||0,d.accuracy+=l.accuracy||0,d.timeliness+=l.timeliness||0,d.consistency+=l.consistency||0,d.usability+=l.usability||0,d.overall+=l.overall||0,d},{completeness:0,accuracy:0,timeliness:0,consistency:0,usability:0,overall:0}),c=a.length,m=a.filter(d=>(d.qualityScores?.overall||0)<50).length;return{avgCompleteness:Math.round(o.completeness/c),avgAccuracy:Math.round(o.accuracy/c),avgTimeliness:Math.round(o.timeliness/c),avgConsistency:Math.round(o.consistency/c),avgUsability:Math.round(o.usability/c),avgOverall:Math.round(o.overall/c),assetsWithIssues:m,assetsWithIssuesPercentage:Math.round(m/c*100)}}function Ve(s){const i=Qe(s),a=He(s),o=s.nodes.filter(m=>m.freshness?.isStale&&m.entityType==="asset").length,c=i.totalAssets>0?Math.round(o/i.totalAssets*100):0;return{coverage:i,quality:a,freshness:{staleAssets:o,stalePercentage:c}}}function $e(s,i){const a=[],o=new Set,c=new Map;s.edges.forEach(d=>{c.has(d.source)||c.set(d.source,[]),c.get(d.source).push(d.target)});function m(d){if(o.has(d))return;o.add(d),(c.get(d)||[]).forEach(l=>{a.includes(l)||a.push(l),m(l)})}return m(i),a}function We(s,i){const a=[],o=new Set,c=new Map;s.edges.forEach(d=>{c.has(d.target)||c.set(d.target,[]),c.get(d.target).push(d.source)});function m(d){if(o.has(d))return;o.add(d),(c.get(d)||[]).forEach(l=>{a.includes(l)||a.push(l),m(l)})}return m(i),a}function _e(s,i="both"){const{nodes:a,edges:o,centerNodeId:c}=s;if(!a.find(j=>j.id===c))return a;const d=[...a],f=new Map,l=new Map;o.forEach(j=>{j.isUpstream?(f.has(j.target)||f.set(j.target,[]),f.get(j.target).push(j.source)):(l.has(j.source)||l.set(j.source,[]),l.get(j.source).push(j.target))});const x=new Map,w=new Set;x.set(c,0),w.add(c);const C=[{id:c,level:0}];for(;C.length>0;){const{id:j,level:t}=C.shift();(i==="upstream"||i==="both")&&(f.get(j)||[]).forEach(S=>{w.has(S)||(w.add(S),x.set(S,t-1),C.push({id:S,level:t-1}))}),(i==="downstream"||i==="both")&&(l.get(j)||[]).forEach(S=>{w.has(S)||(w.add(S),x.set(S,t+1),C.push({id:S,level:t+1}))})}const r=new Map;d.forEach(j=>{const t=x.get(j.id)??0;r.has(t)||r.set(t,[]),r.get(t).push(j)});const n=Math.max(...Array.from(r.keys())),h=Math.min(...Array.from(r.keys())),N=n-h||1,u=300,k=150;return r.forEach((j,t)=>{const S=(t-h)/N*u*N;j.forEach((E,A)=>{const O=(A-j.length/2)*k;E.position={x:S,y:O}})}),d}function Ze(s){const{nodes:i,edges:a,centerNodeId:o}=s,c=i.find(r=>r.id===o);if(!c)return i;const m=[...i],d=new Map(m.map(r=>[r.id,r]));c.position={x:0,y:0};const f=new Map;f.set(o,0);const l=[{id:o,distance:0}],x=new Set([o]);for(;l.length>0;){const{id:r,distance:n}=l.shift();if(!d.get(r))continue;a.filter(u=>u.source===r||u.target===r).map(u=>u.source===r?u.target:u.source).forEach(u=>{x.has(u)||(x.add(u),f.set(u,n+1),l.push({id:u,distance:n+1}))})}const w=new Map;m.forEach(r=>{const n=f.get(r.id)??0;w.has(n)||w.set(n,[]),w.get(n).push(r)});const C=200;return w.forEach((r,n)=>{if(n===0)return;const h=n*C,N=2*Math.PI/r.length;r.forEach((u,k)=>{const j=k*N;u.position={x:h*Math.cos(j),y:h*Math.sin(j)}})}),m}function Je({config:s,centerAsset:i,availableAssets:a,onConfigChange:o,onCenterAssetChange:c,onRefresh:m,loading:d}){const[f,l]=b.useState(!0),[x,w]=b.useState(""),C=Array.from(new Set(a.map(n=>n.typeName).filter(Boolean))).sort(),r=a.filter(n=>{if(!x)return!0;const h=x.toLowerCase();return n.name?.toLowerCase().includes(h)||n.qualifiedName?.toLowerCase().includes(h)||n.guid.toLowerCase().includes(h)});return e.jsxs("div",{className:"lineage-config-panel",children:[e.jsxs("div",{className:"lineage-config-header",onClick:()=>l(!f),children:[e.jsxs("div",{className:"lineage-config-title",children:[e.jsx(oe,{size:16}),e.jsx("span",{children:"Configuration"})]}),e.jsxs("div",{className:"lineage-config-actions",children:[e.jsx("button",{className:"icon-button",onClick:n=>{n.stopPropagation(),m()},disabled:d,title:"Refresh lineage",children:e.jsx(ce,{size:16,className:d?"spinning":""})}),f?e.jsx(Le,{size:16}):e.jsx(de,{size:16})]})]}),f&&e.jsxs("div",{className:"lineage-config-content",children:[e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Center Asset"}),e.jsxs("div",{className:"asset-search-wrapper",children:[e.jsx(he,{size:14,className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Search assets...",value:x,onChange:n=>w(n.target.value),className:"asset-search-input"})]}),e.jsx("select",{value:i.guid,onChange:n=>{const h=r.find(N=>N.guid===n.target.value);h&&c(h)},className:"asset-select",children:r.map(n=>e.jsx("option",{value:n.guid,children:n.name||n.qualifiedName||n.guid},n.guid))})]}),e.jsx("div",{className:"config-section",children:e.jsxs("label",{children:["Depth: ",s.depth,e.jsx("input",{type:"range",min:"1",max:"5",value:s.depth,onChange:n=>o({depth:parseInt(n.target.value)})})]})}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Direction"}),e.jsxs("div",{className:"radio-group",children:[e.jsxs("label",{children:[e.jsx("input",{type:"radio",value:"both",checked:s.direction==="both",onChange:n=>o({direction:n.target.value})}),"Both"]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",value:"upstream",checked:s.direction==="upstream",onChange:n=>o({direction:n.target.value})}),"Upstream"]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",value:"downstream",checked:s.direction==="downstream",onChange:n=>o({direction:n.target.value})}),"Downstream"]})]})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Layout"}),e.jsxs("select",{value:s.layout,onChange:n=>o({layout:n.target.value}),children:[e.jsx("option",{value:"hierarchical",children:"Hierarchical"}),e.jsx("option",{value:"radial",children:"Radial"})]})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"View Mode"}),e.jsxs("div",{className:"radio-group",children:[e.jsxs("label",{children:[e.jsx("input",{type:"radio",value:"table",checked:s.viewMode==="table",onChange:n=>o({viewMode:n.target.value})}),"Table"]}),e.jsxs("label",{children:[e.jsx("input",{type:"radio",value:"column",checked:s.viewMode==="column",onChange:n=>o({viewMode:n.target.value})}),"Column"]})]})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Filter by Type"}),e.jsx("div",{className:"checkbox-group",children:C.map(n=>e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.filterByType.includes(n),onChange:h=>{const N=h.target.checked?[...s.filterByType,n]:s.filterByType.filter(u=>u!==n);o({filterByType:N})}}),n]},n))})]}),e.jsxs("div",{className:"config-section",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.filterByQuality.enabled,onChange:n=>o({filterByQuality:{...s.filterByQuality,enabled:n.target.checked}})}),"Filter by Quality"]}),s.filterByQuality.enabled&&e.jsxs("label",{className:"sub-label",children:["Threshold: < ",s.filterByQuality.threshold,e.jsx("input",{type:"range",min:"0",max:"100",value:s.filterByQuality.threshold,onChange:n=>o({filterByQuality:{...s.filterByQuality,threshold:parseInt(n.target.value)}})})]})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Analysis Modes"}),e.jsxs("div",{className:"checkbox-group",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.impactAnalysisMode,onChange:n=>o({impactAnalysisMode:n.target.checked})}),"Impact Analysis"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.rootCauseMode,onChange:n=>o({rootCauseMode:n.target.checked})}),"Root Cause Analysis"]})]})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("label",{children:"Display Options"}),e.jsxs("div",{className:"checkbox-group",children:[e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.showCoverage,onChange:n=>o({showCoverage:n.target.checked})}),"Show Coverage Indicators"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.showQualityScores,onChange:n=>o({showQualityScores:n.target.checked})}),"Show Quality Scores"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.showFreshness,onChange:n=>o({showFreshness:n.target.checked})}),"Show Freshness Indicators"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.showGovernance,onChange:n=>o({showGovernance:n.target.checked})}),"Show Governance Badges"]}),e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:s.showMetrics,onChange:n=>o({showMetrics:n.target.checked})}),"Show Metrics Panel"]})]})]})]})]})}function Xe({metrics:s}){const{coverage:i,quality:a,freshness:o}=s;return e.jsxs("div",{className:"lineage-metrics-panel",children:[e.jsxs("div",{className:"lineage-metrics-header",children:[e.jsx(ue,{size:16}),e.jsx("span",{children:"Metrics"})]}),e.jsxs("div",{className:"lineage-metrics-content",children:[e.jsxs("div",{className:"metrics-section",children:[e.jsx("h4",{children:"Coverage"}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Total Assets:"}),e.jsx("span",{className:"metric-value",children:i.totalAssets})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Total Processes:"}),e.jsx("span",{className:"metric-value",children:i.totalProcesses})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"With Upstream:"}),e.jsx("span",{className:"metric-value",children:i.withUpstream}),e.jsxs("span",{className:"metric-percentage",children:["(",Math.round(i.withUpstream/i.totalAssets*100),"%)"]})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"With Downstream:"}),e.jsx("span",{className:"metric-value",children:i.withDownstream}),e.jsxs("span",{className:"metric-percentage",children:["(",Math.round(i.withDownstream/i.totalAssets*100),"%)"]})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Full Lineage:"}),e.jsx("span",{className:"metric-value",children:i.withFullLineage}),e.jsxs("span",{className:"metric-percentage",children:["(",Math.round(i.withFullLineage/i.totalAssets*100),"%)"]})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Orphaned:"}),e.jsx("span",{className:`metric-value ${i.orphaned>0?"metric-warning":""}`,children:i.orphaned}),i.orphaned>0&&e.jsx(G,{size:14,className:"metric-icon-warning"})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Coverage:"}),e.jsxs("span",{className:`metric-value metric-score-${i.coveragePercentage>=80?"high":i.coveragePercentage>=50?"medium":"low"}`,children:[i.coveragePercentage,"%"]})]})]}),a.avgOverall>0&&e.jsxs("div",{className:"metrics-section",children:[e.jsx("h4",{children:"Quality Scores"}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Overall:"}),e.jsx("span",{className:`metric-value metric-score-${a.avgOverall>=80?"high":a.avgOverall>=50?"medium":"low"}`,children:a.avgOverall})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Completeness:"}),e.jsx("span",{className:"metric-value",children:a.avgCompleteness})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Accuracy:"}),e.jsx("span",{className:"metric-value",children:a.avgAccuracy})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Timeliness:"}),e.jsx("span",{className:"metric-value",children:a.avgTimeliness})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Consistency:"}),e.jsx("span",{className:"metric-value",children:a.avgConsistency})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Usability:"}),e.jsx("span",{className:"metric-value",children:a.avgUsability})]}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Assets with Issues:"}),e.jsx("span",{className:`metric-value ${a.assetsWithIssues>0?"metric-warning":""}`,children:a.assetsWithIssues}),e.jsxs("span",{className:"metric-percentage",children:["(",a.assetsWithIssuesPercentage,"%)"]}),a.assetsWithIssues>0&&e.jsx(G,{size:14,className:"metric-icon-warning"})]})]}),o&&e.jsxs("div",{className:"metrics-section",children:[e.jsx("h4",{children:"Freshness"}),e.jsxs("div",{className:"metric-row",children:[e.jsx("span",{className:"metric-label",children:"Stale Assets:"}),e.jsx("span",{className:`metric-value ${o.staleAssets>0?"metric-warning":""}`,children:o.staleAssets}),e.jsxs("span",{className:"metric-percentage",children:["(",o.stalePercentage,"%)"]}),o.staleAssets>0&&e.jsx(G,{size:14,className:"metric-icon-warning"})]})]})]})]})}const Ke=b.memo(Xe),Ye={Database:Y,Schema:$,Table:me,View:W,MaterializedView:W,Column:$,Process:B,ColumnProcess:B,BIProcess:B,SparkJob:B},es=Y;function ss({data:s,selected:i}){const{label:a,type:o,entityType:c,isCenterNode:m,hasUpstream:d,hasDownstream:f,qualityScores:l,governance:x,freshness:w,isHighlighted:C,highlightReason:r}=s,n=Ye[o]||es,h=c==="process",N=l?.overall||0;let u="node-default";h?u="node-process":m?u="node-center":N>0?N<50?u="node-quality-low":N<80?u="node-quality-medium":u="node-quality-high":d&&f?u="node-lineage-full":d||f?u="node-lineage-partial":u="node-lineage-orphaned",C&&(r==="impact"?u+=" node-highlight-impact":r==="root-cause"?u+=" node-highlight-root-cause":r==="quality-issue"&&(u+=" node-highlight-quality"));const k=w?.isStale,j=w?.stalenessDays;return e.jsxs("div",{className:`lineage-node ${u} ${i?"selected":""} ${m?"center":""}`,children:[e.jsx(_,{type:"target",position:R.Left,className:"lineage-handle lineage-handle-input"}),e.jsxs("div",{className:"lineage-node-content",children:[e.jsxs("div",{className:"lineage-node-header",children:[e.jsxs("div",{className:"lineage-node-icon-wrapper",children:[e.jsx(n,{size:16,className:"lineage-node-icon"}),h&&e.jsx("span",{className:"lineage-node-badge lineage-node-badge-process",children:"Process"}),!h&&e.jsx("span",{className:"lineage-node-badge",children:o})]}),l?.overall!==void 0&&e.jsx("div",{className:`lineage-node-quality ${N<50?"low":N<80?"medium":"high"}`,children:N})]}),e.jsx("div",{className:"lineage-node-label",title:a,children:a}),e.jsxs("div",{className:"lineage-node-badges",children:[s.hasCertificate&&x?.certificateStatus&&e.jsxs("span",{className:"lineage-node-badge-small",title:`Certified: ${x.certificateStatus}`,children:[x.certificateStatus==="VERIFIED"&&e.jsx(pe,{size:10}),x.certificateStatus==="DRAFT"&&e.jsx(G,{size:10}),x.certificateStatus==="DEPRECATED"&&e.jsx(Ie,{size:10})]}),s.hasOwner&&e.jsx("span",{className:"lineage-node-badge-small",title:"Has owner",children:e.jsx(ge,{size:10})}),s.hasTags&&e.jsx("span",{className:"lineage-node-badge-small",title:"Has tags",children:e.jsx(fe,{size:10})}),s.hasDescription&&e.jsx("span",{className:"lineage-node-badge-small",title:"Has description",children:e.jsx(xe,{size:10})}),k&&e.jsx("span",{className:"lineage-node-badge-small lineage-node-badge-stale",title:`Stale: ${j} days`,children:e.jsx(ye,{size:10})})]}),e.jsxs("div",{className:"lineage-node-lineage-info",children:[d&&e.jsxs("span",{className:"lineage-node-lineage-badge upstream",title:`${s.upstreamCount} upstream`,children:["↑ ",s.upstreamCount]}),f&&e.jsxs("span",{className:"lineage-node-lineage-badge downstream",title:`${s.downstreamCount} downstream`,children:["↓ ",s.downstreamCount]})]}),s.isExpandable&&!s.isExpanded&&e.jsxs("div",{className:"lineage-node-expand",children:[e.jsx(je,{size:12}),e.jsx("span",{children:"+"})]})]}),e.jsx(_,{type:"source",position:R.Right,className:"lineage-handle lineage-handle-output"})]})}const ts=b.memo(ss);function as({id:s,sourceX:i,sourceY:a,targetX:o,targetY:c,sourcePosition:m=R.Right,targetPosition:d=R.Left,style:f={},markerEnd:l,data:x,selected:w}){const[C]=Me({sourceX:i,sourceY:a,sourcePosition:m,targetX:o,targetY:c,targetPosition:d}),r=x?.isUpstream||!1,n=x?.relationshipType||"unknown";let h="lineage-edge";r?h+=" lineage-edge-upstream":h+=" lineage-edge-downstream",(n.includes("Process")||x?.sourceType?.includes("Process")||x?.targetType?.includes("Process"))&&(h+=" lineage-edge-process"),w&&(h+=" selected");const N=!r;return e.jsxs(e.Fragment,{children:[e.jsx(Ee,{id:s,path:C,markerEnd:l,style:{...f,strokeWidth:w?3:2},className:h}),N&&e.jsx("path",{d:C,fill:"none",stroke:"url(#lineage-gradient)",strokeWidth:1,className:"lineage-edge-animated"})]})}const ns=b.memo(as),is={lineageNode:ts},rs={lineageEdge:ns},ls={depth:3,direction:"both",viewMode:"table",layout:"hierarchical",filterByType:[],filterByConnection:[],filterByQuality:{enabled:!1,threshold:50},filterByGovernance:{enabled:!1,showOnlyUncertified:!1,showOnlyOrphaned:!1},showCoverage:!0,showQualityScores:!0,showFreshness:!0,showGovernance:!0,showMetrics:!0,showEdgeLabels:!1,impactAnalysisMode:!1,rootCauseMode:!1};function os(){const{contextAssets:s}=ve(),[i]=we(),[a,o]=b.useState(ls),[c,m]=b.useState(!1),[d,f]=b.useState(null),[l,x]=b.useState(null),[w,C]=b.useState(null),[r,n]=b.useState(null),[h,N]=b.useState(null),[u,k]=b.useState(null),[j,t]=b.useState(null);b.useEffect(()=>{const y=i.get("guid");n(g=>{if(y&&s.length>0){const T=s.find(U=>U.guid===y);if(T&&T.guid!==g?.guid)return T}return!g&&s.length>0?s[0]:g})},[i,s]);const M=b.useCallback(async()=>{if(!r){f("Please select an asset to view lineage");return}j&&j.abort();const y=new AbortController;t(y),m(!0),f(null);try{const g=await Ne(r.guid,a.direction,a.depth);if(!g){f("Invalid response from lineage API");return}const T=Object.values(g.guidEntityMap||{}),U=[...T];T.find(L=>L.guid===r.guid)||U.push(r);let v=new Map;try{const L=U.filter(D=>D.typeName==="Table"||D.typeName==="View"||D.typeName==="MaterializedView");(await be(L)).forEach((D,ne)=>{const F=D.find(z=>z.profileId==="standard")||D[0];if(!F)return;const ie=F.dimensions||[],I=z=>{const H=ie.find(re=>re.dimension===z);return H?Math.round(H.score01*100):0};v.set(ne,{overall:Math.round(F.score*100),completeness:I("completeness"),accuracy:I("accuracy"),timeliness:I("timeliness"),consistency:I("consistency"),usability:I("usability")})})}catch(L){console.warn("Failed to fetch quality scores:",L)}const p=qe(r,g,a.direction,v);let P;a.layout==="radial"?P=Ze(p):P=_e(p,a.direction);const Q={...p,nodes:P};if(y.signal.aborted)return;x(Q),C(Ve(Q))}catch(g){if(y.signal.aborted)return;console.error("Failed to fetch lineage:",g),f(g instanceof Error?g.message:"Failed to fetch lineage")}finally{y.signal.aborted||m(!1)}},[r,a.depth,a.direction,a.layout]);b.useEffect(()=>{r&&M()},[r,a.depth,a.direction,a.layout]);const[S,E]=b.useState(new Set);b.useEffect(()=>{if(a.impactAnalysisMode&&h&&l){const y=$e(l,h);E(new Set(y))}else if(a.rootCauseMode&&h&&l){const y=We(l,h);E(new Set(y))}else E(new Set)},[a.impactAnalysisMode,a.rootCauseMode,h,l]);const{nodes:A,edges:O}=b.useMemo(()=>{if(!l)return{nodes:[],edges:[]};let y=l.nodes,g=l.edges;if(a.filterByType.length>0){y=y.filter(p=>a.filterByType.includes(p.type));const v=new Set(y.map(p=>p.guid));g=g.filter(p=>v.has(p.source)&&v.has(p.target))}if(a.filterByConnection.length>0){y=y.filter(p=>{const P=p.data.connectionName||p.data.connectionQualifiedName;return P&&a.filterByConnection.includes(P)});const v=new Set(y.map(p=>p.guid));g=g.filter(p=>v.has(p.source)&&v.has(p.target))}if(a.filterByQuality.enabled){y=y.filter(p=>(p.qualityScores?.overall||0)<a.filterByQuality.threshold);const v=new Set(y.map(p=>p.guid));g=g.filter(p=>v.has(p.source)&&v.has(p.target))}if(a.filterByGovernance.enabled){y=y.filter(p=>a.filterByGovernance.showOnlyUncertified?!p.governance?.certificateStatus||p.governance.certificateStatus!=="VERIFIED":a.filterByGovernance.showOnlyOrphaned?!p.hasUpstream&&!p.hasDownstream:!0);const v=new Set(y.map(p=>p.guid));g=g.filter(p=>v.has(p.source)&&v.has(p.target))}const T=y.map(v=>({id:v.id,type:"lineageNode",position:v.position||{x:0,y:0},data:{...v,isHighlighted:S.has(v.id),highlightReason:S.has(v.id)?a.impactAnalysisMode?"impact":a.rootCauseMode?"root-cause":void 0:void 0},selected:v.id===h})),U=g.map(v=>({id:v.id,source:v.source,target:v.target,type:"lineageEdge",data:v,animated:a.showEdgeLabels&&!v.isUpstream,selected:!1}));return console.log("[LineageView] ReactFlow nodes:",T.length),console.log("[LineageView] ReactFlow edges:",U.length,U.map(v=>({id:v.id,source:v.source,target:v.target}))),{nodes:T,edges:U}},[l,a,h,S]);b.useEffect(()=>{A.length>0&&u&&setTimeout(()=>{u.fitView({padding:.2,duration:400})},100)},[A.length,u]);const ee=b.useCallback(y=>{o(g=>({...g,...y}))},[]),se=b.useCallback(y=>{n(y),N(null)},[]),te=b.useCallback((y,g)=>{N(g.id)},[]),ae=b.useCallback(()=>{N(null)},[]);return r?e.jsxs("div",{className:"lineage-view",children:[e.jsx(Je,{config:a,centerAsset:r,availableAssets:s,onConfigChange:ee,onCenterAssetChange:se,onRefresh:M,loading:c}),e.jsxs("div",{className:"lineage-view-graph",children:[d&&e.jsxs("div",{className:"lineage-view-error",children:[e.jsxs("p",{children:["Error: ",d]}),e.jsx("button",{onClick:M,children:"Retry"})]}),c&&e.jsxs("div",{className:"lineage-view-loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading lineage..."})]}),!c&&!d&&l&&e.jsxs(Te,{nodes:A,edges:O,nodeTypes:is,edgeTypes:rs,onNodeClick:te,onPaneClick:ae,onInit:k,fitView:!0,minZoom:.1,maxZoom:2,defaultViewport:{x:0,y:0,zoom:1},children:[e.jsx("svg",{style:{position:"absolute",width:0,height:0},children:e.jsx("defs",{children:e.jsxs("linearGradient",{id:"lineage-gradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"currentColor",stopOpacity:"0"}),e.jsx("stop",{offset:"50%",stopColor:"currentColor",stopOpacity:"0.5"}),e.jsx("stop",{offset:"100%",stopColor:"currentColor",stopOpacity:"0"})]})})}),e.jsx(ke,{color:"#e5e7eb",gap:20}),e.jsx(Ae,{position:"bottom-right"}),e.jsx(Ue,{nodeColor:y=>{const g=y.data;if(g?.guid===r?.guid)return"#3b82f6";if(g?.qualityScores?.overall){const T=g.qualityScores.overall;return T<50?"#ef4444":T<80?"#f59e0b":"#10b981"}return g?.hasUpstream&&g?.hasDownstream?"#10b981":g?.hasUpstream||g?.hasDownstream?"#f59e0b":"#9ca3af"},maskColor:"rgba(0, 0, 0, 0.1)",position:"bottom-left"}),a.showMetrics&&w&&e.jsx(Pe,{position:"top-right",children:e.jsx(Ke,{metrics:w})})]})]})]}):e.jsx("div",{className:"lineage-view",children:e.jsxs("div",{className:"lineage-view-empty",children:[e.jsx("h2",{children:"Select an Asset"}),e.jsx("p",{children:"Please select an asset from the asset browser to view its lineage."})]})})}function ws(){const{toggleTab:s,activeTab:i,isOpen:a}=Ce();return e.jsxs("div",{className:"lineage-view-page",children:[e.jsx(Be,{title:"Lineage Explorer",children:e.jsxs(Ge,{children:[e.jsx(Z,{children:e.jsx(q,{icon:e.jsx(Oe,{}),onClick:()=>s("config"),active:a&&i==="config",title:"Configure Lineage Graph"})}),e.jsx(Re,{}),e.jsxs(Z,{children:[e.jsx(q,{icon:e.jsx(Se,{}),disabled:!0,title:"Snapshot Graph State (Coming Soon)"}),e.jsx(q,{icon:e.jsx(Fe,{}),title:"Export Image"})]})]})}),e.jsx("div",{className:"lineage-view-container",children:e.jsx(De,{children:e.jsx(os,{})})})]})}export{ws as LineageViewPage};
