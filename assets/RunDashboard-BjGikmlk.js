const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BYXjn4hA.js","assets/index-D6rk21NC.css"])))=>i.map(i=>d[i]);
import{r as w,j as n,X as nt,a$ as ot,b0 as lt,at as K,aj as ht,aw as dt,b1 as ct,b2 as B,b3 as gt,b4 as pt}from"./index-BYXjn4hA.js";import{g as ut,i as _t,a as ft,b as mt,d as xt,e as z,f as J,r as bt,h as wt,j as Z,k as yt,l as tt}from"./v2Api-zEssVn_2.js";function vt({isOpen:a,onClose:t,assetQualifiedName:e,assetName:s,runId:i}){const[r,l]=w.useState([]),[o,d]=w.useState(!1);if(w.useEffect(()=>{if(!a||!i||!e)return;(async()=>{d(!0);try{const f=(await(await fetch(`/api/runs/${i}/catalog`)).json()).find(m=>m.qualifiedName===e);f?.signals&&l(f.signals)}catch(c){console.error("Failed to fetch signals:",c)}finally{d(!1)}})()},[a,i,e]),!a)return null;const g=h=>{switch(h){case"OWNERSHIP":return"bg-purple-100 text-purple-800";case"SEMANTICS":return"bg-blue-100 text-blue-800";case"LINEAGE":return"bg-green-100 text-green-800";case"SENSITIVITY":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return n.jsxs("div",{className:"fixed inset-0 z-50 flex justify-end",children:[n.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:t}),n.jsxs("div",{className:"relative bg-white w-full max-w-2xl shadow-xl overflow-y-auto",children:[n.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-bold text-gray-900",children:s}),n.jsx("p",{className:"text-sm text-gray-500",children:e})]}),n.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-100 rounded-lg transition",children:n.jsx(nt,{className:"w-5 h-5"})})]}),n.jsx("div",{className:"p-6",children:o?n.jsx("div",{className:"text-center py-12 text-gray-500",children:"Loading evidence..."}):r.length===0?n.jsx("div",{className:"text-center py-12 text-gray-500",children:"No evidence signals found"}):n.jsx("div",{className:"space-y-4",children:r.map(h=>n.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[n.jsxs("div",{className:"flex items-start justify-between mb-2",children:[n.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${g(h.signalType)}`,children:h.signalType}),n.jsx("span",{className:"text-xs text-gray-500",children:h.observedAt?new Date(h.observedAt).toLocaleString():"Not observed in run"})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"Source"}),n.jsx("div",{className:"text-sm text-gray-600",children:h.signalSource})]}),n.jsxs("div",{className:"mt-3",children:[n.jsx("div",{className:"text-sm font-medium text-gray-700 mb-1",children:"Value"}),n.jsx("pre",{className:"text-xs bg-white p-2 rounded border border-gray-200 overflow-x-auto",children:JSON.stringify(h.signalValue,null,2)})]})]},h.id))})})]})]})}const W="year",U="month",q="day",X="hour",G="minute",P="second",et="millisecond",u={parse_duration(a){const t=/([0-9]+)(y|m|d|h|min|s|ms)/gm.exec(a);if(t!==null){if(t[2]==="y")return{duration:parseInt(t[1]),scale:"year"};if(t[2]==="m")return{duration:parseInt(t[1]),scale:"month"};if(t[2]==="d")return{duration:parseInt(t[1]),scale:"day"};if(t[2]==="h")return{duration:parseInt(t[1]),scale:"hour"};if(t[2]==="min")return{duration:parseInt(t[1]),scale:"minute"};if(t[2]==="s")return{duration:parseInt(t[1]),scale:"second"};if(t[2]==="ms")return{duration:parseInt(t[1]),scale:"millisecond"}}},parse(a,t="-",e=/[.:]/){if(a instanceof Date)return a;if(typeof a=="string"){let s,i;const r=a.split(" ");s=r[0].split(t).map(o=>parseInt(o,10)),i=r[1]&&r[1].split(e),s[1]=s[1]?s[1]-1:0;let l=s;return i&&i.length&&(i.length===4&&(i[3]="0."+i[3],i[3]=parseFloat(i[3])*1e3),l=l.concat(i)),new Date(...l)}},to_string(a,t=!1){if(!(a instanceof Date))throw new TypeError("Invalid argument type");const e=this.get_date_values(a).map((r,l)=>(l===1&&(r=r+1),l===6?E(r+"",3,"0"):E(r+"",2,"0"))),s=`${e[0]}-${e[1]}-${e[2]}`,i=`${e[3]}:${e[4]}:${e[5]}.${e[6]}`;return s+(t?" "+i:"")},format(a,t="YYYY-MM-DD HH:mm:ss.SSS",e="en"){const s=new Intl.DateTimeFormat(e,{month:"long"}),i=new Intl.DateTimeFormat(e,{month:"short"}),r=s.format(a),l=r.charAt(0).toUpperCase()+r.slice(1),o=this.get_date_values(a).map(c=>E(c,2,0)),d={YYYY:o[0],MM:E(+o[1]+1,2,0),DD:o[2],HH:o[3],mm:o[4],ss:o[5],SSS:o[6],D:o[2],MMMM:l,MMM:i.format(a)};let g=t;const h=[];return Object.keys(d).sort((c,_)=>_.length-c.length).forEach(c=>{g.includes(c)&&(g=g.replaceAll(c,`$${h.length}`),h.push(d[c]))}),h.forEach((c,_)=>{g=g.replaceAll(`$${_}`,c)}),g},diff(a,t,e="day"){let s,i,r,l,o,d,g;s=a-t+(t.getTimezoneOffset()-a.getTimezoneOffset())*6e4,i=s/1e3,l=i/60,r=l/60,o=r/24;let h=a.getFullYear()-t.getFullYear(),c=a.getMonth()-t.getMonth();return c+=o%30/30,d=h*12+c,a.getDate()<t.getDate()&&d--,g=d/12,e.endsWith("s")||(e+="s"),Math.round({milliseconds:s,seconds:i,minutes:l,hours:r,days:o,months:d,years:g}[e]*100)/100},today(){const a=this.get_date_values(new Date).slice(0,3);return new Date(...a)},now(){return new Date},add(a,t,e){t=parseInt(t,10);const s=[a.getFullYear()+(e===W?t:0),a.getMonth()+(e===U?t:0),a.getDate()+(e===q?t:0),a.getHours()+(e===X?t:0),a.getMinutes()+(e===G?t:0),a.getSeconds()+(e===P?t:0),a.getMilliseconds()+(e===et?t:0)];return new Date(...s)},start_of(a,t){const e={[W]:6,[U]:5,[q]:4,[X]:3,[G]:2,[P]:1,[et]:0};function s(r){const l=e[t];return e[r]<=l}const i=[a.getFullYear(),s(W)?0:a.getMonth(),s(U)?1:a.getDate(),s(q)?0:a.getHours(),s(X)?0:a.getMinutes(),s(G)?0:a.getSeconds(),s(P)?0:a.getMilliseconds()];return new Date(...i)},clone(a){return new Date(...this.get_date_values(a))},get_date_values(a){return[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds()]},convert_scales(a,t){const e={millisecond:11574074074074074e-24,second:11574074074074073e-21,minute:.0006944444444444445,hour:.041666666666666664,day:1,month:30,year:365},{duration:s,scale:i}=this.parse_duration(a);return s*e[i]/e[t]},get_days_in_month(a){const t=[31,28,31,30,31,30,31,31,30,31,30,31],e=a.getMonth();if(e!==1)return t[e];const s=a.getFullYear();return s%4===0&&s%100!=0||s%400===0?29:28},get_days_in_year(a){return a.getFullYear()%4?365:366}};function E(a,t,e){return a=a+"",t=t>>0,e=String(typeof e<"u"?e:" "),a.length>t?String(a):(t=t-a.length,t>e.length&&(e+=e.repeat(t/e.length)),e.slice(0,t)+String(a))}function x(a,t){return typeof a=="string"?(t||document).querySelector(a):a||null}function y(a,t){const e=document.createElementNS("http://www.w3.org/2000/svg",a);for(let s in t)s==="append_to"?t.append_to.appendChild(e):s==="innerHTML"?e.innerHTML=t.innerHTML:s==="clipPath"?e.setAttribute("clip-path","url(#"+t[s]+")"):e.setAttribute(s,t[s]);return e}function R(a,t,e,s){const i=kt(a,t,e,s);if(i===a){const r=document.createEvent("HTMLEvents");r.initEvent("click",!0,!0),r.eventName="click",i.dispatchEvent(r)}}function kt(a,t,e,s,i="0.4s",r="0.1s"){const l=a.querySelector("animate");if(l)return x.attr(l,{attributeName:t,from:e,to:s,dur:i,begin:"click + "+r}),a;const o=y("animate",{attributeName:t,from:e,to:s,dur:i,begin:r,calcMode:"spline",values:e+";"+s,keyTimes:"0; 1",keySplines:Nt("ease-out")});return a.appendChild(o),a}function Nt(a){return{ease:".25 .1 .25 1",linear:"0 0 1 1","ease-in":".42 0 1 1","ease-out":"0 0 .58 1","ease-in-out":".42 0 .58 1"}[a]}x.on=(a,t,e,s)=>{s?x.delegate(a,t,e,s):(s=e,x.bind(a,t,s))};x.off=(a,t,e)=>{a.removeEventListener(t,e)};x.bind=(a,t,e)=>{t.split(/\s+/).forEach(function(s){a.addEventListener(s,e)})};x.delegate=(a,t,e,s)=>{a.addEventListener(t,function(i){const r=i.target.closest(e);r&&(i.delegatedTarget=r,s.call(this,i,r))})};x.closest=(a,t)=>t?t.matches(a)?t:x.closest(a,t.parentNode):null;x.attr=(a,t,e)=>{if(!e&&typeof t=="string")return a.getAttribute(t);if(typeof t=="object"){for(let s in t)x.attr(a,s,t[s]);return}a.setAttribute(t,e)};class $t{constructor(t,e,s){this.gantt=t,this.from_task=e,this.to_task=s,this.calculate_path(),this.draw()}calculate_path(){let t=this.from_task.$bar.getX()+this.from_task.$bar.getWidth()/2;const e=()=>this.to_task.$bar.getX()<t+this.gantt.options.padding&&t>this.from_task.$bar.getX()+this.gantt.options.padding;for(;e();)t-=10;t-=10;let s=this.gantt.config.header_height+this.gantt.options.bar_height+(this.gantt.options.padding+this.gantt.options.bar_height)*this.from_task.task._index+this.gantt.options.padding/2,i=this.to_task.$bar.getX()-13,r=this.gantt.config.header_height+this.gantt.options.bar_height/2+(this.gantt.options.padding+this.gantt.options.bar_height)*this.to_task.task._index+this.gantt.options.padding/2;const l=this.from_task.task._index>this.to_task.task._index;let o=this.gantt.options.arrow_curve;const d=l?1:0;let g=l?-o:o;if(this.to_task.$bar.getX()<=this.from_task.$bar.getX()+this.gantt.options.padding){let h=this.gantt.options.padding/2-o;h<0&&(h=0,o=this.gantt.options.padding/2,g=l?-o:o);const c=this.to_task.$bar.getY()+this.to_task.$bar.getHeight()/2-g,_=this.to_task.$bar.getX()-this.gantt.options.padding;this.path=`
                M ${t} ${s}
                v ${h}
                a ${o} ${o} 0 0 1 ${-o} ${o}
                H ${_}
                a ${o} ${o} 0 0 ${d} ${-o} ${g}
                V ${c}
                a ${o} ${o} 0 0 ${d} ${o} ${g}
                L ${i} ${r}
                m -5 -5
                l 5 5
                l -5 5`}else{i<t+o&&(o=i-t);let h=l?r+o:r-o;this.path=`
              M ${t} ${s}
              V ${h}
              a ${o} ${o} 0 0 ${d} ${o} ${o}
              L ${i} ${r}
              m -5 -5
              l 5 5
              l -5 5`}}draw(){this.element=y("path",{d:this.path,"data-from":this.from_task.task.id,"data-to":this.to_task.task.id})}update(){this.calculate_path(),this.element.setAttribute("d",this.path)}}class jt{constructor(t,e){this.set_defaults(t,e),this.prepare_wrappers(),this.prepare_helpers(),this.refresh()}refresh(){this.bar_group.innerHTML="",this.handle_group.innerHTML="",this.task.custom_class?this.group.classList.add(this.task.custom_class):this.group.classList=["bar-wrapper"],this.prepare_values(),this.draw(),this.bind()}set_defaults(t,e){this.action_completed=!1,this.gantt=t,this.task=e,this.name=this.name||""}prepare_wrappers(){this.group=y("g",{class:"bar-wrapper"+(this.task.custom_class?" "+this.task.custom_class:""),"data-id":this.task.id}),this.bar_group=y("g",{class:"bar-group",append_to:this.group}),this.handle_group=y("g",{class:"handle-group",append_to:this.group})}prepare_values(){this.invalid=this.task.invalid,this.height=this.gantt.options.bar_height,this.image_size=this.height-5,this.task._start=new Date(this.task.start),this.task._end=new Date(this.task.end),this.compute_x(),this.compute_y(),this.compute_duration(),this.corner_radius=this.gantt.options.bar_corner_radius,this.width=this.gantt.config.column_width*this.duration,(!this.task.progress||this.task.progress<0)&&(this.task.progress=0),this.task.progress>100&&(this.task.progress=100)}prepare_helpers(){SVGElement.prototype.getX=function(){return+this.getAttribute("x")},SVGElement.prototype.getY=function(){return+this.getAttribute("y")},SVGElement.prototype.getWidth=function(){return+this.getAttribute("width")},SVGElement.prototype.getHeight=function(){return+this.getAttribute("height")},SVGElement.prototype.getEndX=function(){return this.getX()+this.getWidth()}}prepare_expected_progress_values(){this.compute_expected_progress(),this.expected_progress_width=this.gantt.options.column_width*this.duration*(this.expected_progress/100)||0}draw(){this.draw_bar(),this.draw_progress_bar(),this.gantt.options.show_expected_progress&&(this.prepare_expected_progress_values(),this.draw_expected_progress_bar()),this.draw_label(),this.draw_resize_handles(),this.task.thumbnail&&this.draw_thumbnail()}draw_bar(){this.$bar=y("rect",{x:this.x,y:this.y,width:this.width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar",append_to:this.bar_group}),this.task.color&&(this.$bar.style.fill=this.task.color),R(this.$bar,"width",0,this.width),this.invalid&&this.$bar.classList.add("bar-invalid")}draw_expected_progress_bar(){this.invalid||(this.$expected_bar_progress=y("rect",{x:this.x,y:this.y,width:this.expected_progress_width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar-expected-progress",append_to:this.bar_group}),R(this.$expected_bar_progress,"width",0,this.expected_progress_width))}draw_progress_bar(){if(this.invalid)return;this.progress_width=this.calculate_progress_width();let t=this.corner_radius;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(t=this.corner_radius+2),this.$bar_progress=y("rect",{x:this.x,y:this.y,width:this.progress_width,height:this.height,rx:t,ry:t,class:"bar-progress",append_to:this.bar_group}),this.task.color_progress&&(this.$bar_progress.style.fill=this.task.color_progress);const e=u.diff(this.task._start,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let s=this.gantt.create_el({classes:`date-range-highlight hide highlight-${this.task.id}`,width:this.width,left:e});this.$date_highlight=s,this.gantt.$lower_header.prepend(this.$date_highlight),R(this.$bar_progress,"width",0,this.progress_width)}calculate_progress_width(){const t=this.$bar.getWidth(),e=this.x+t,s=this.gantt.config.ignored_positions.reduce((d,g)=>d+(g>=this.x&&g<e),0)*this.gantt.config.column_width;let i=(t-s)*this.task.progress/100;const r=this.x+i,l=this.gantt.config.ignored_positions.reduce((d,g)=>d+(g>=this.x&&g<r),0)*this.gantt.config.column_width;i+=l;let o=this.gantt.get_ignored_region(this.x+i);for(;o.length;)i+=this.gantt.config.column_width,o=this.gantt.get_ignored_region(this.x+i);return this.progress_width=i,i}draw_label(){let t=this.x+this.$bar.getWidth()/2;this.task.thumbnail&&(t=this.x+this.image_size+5),y("text",{x:t,y:this.y+this.height/2,innerHTML:this.task.name,class:"bar-label",append_to:this.bar_group}),requestAnimationFrame(()=>this.update_label_position())}draw_thumbnail(){let t=10,e=2,s,i;s=y("defs",{append_to:this.bar_group}),y("rect",{id:"rect_"+this.task.id,x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,rx:"15",class:"img_mask",append_to:s}),i=y("clipPath",{id:"clip_"+this.task.id,append_to:s}),y("use",{href:"#rect_"+this.task.id,append_to:i}),y("image",{x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,class:"bar-img",href:this.task.thumbnail,clipPath:"clip_"+this.task.id,append_to:this.bar_group})}draw_resize_handles(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar,e=3;if(this.handles=[],this.gantt.options.readonly_dates||(this.handles.push(y("rect",{x:t.getEndX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle right",append_to:this.handle_group})),this.handles.push(y("rect",{x:t.getX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle left",append_to:this.handle_group}))),!this.gantt.options.readonly_progress){const s=this.$bar_progress;this.$handle_progress=y("circle",{cx:s.getEndX(),cy:s.getY()+s.getHeight()/2,r:4.5,class:"handle progress",append_to:this.handle_group}),this.handles.push(this.$handle_progress)}for(let s of this.handles)x.on(s,"mouseenter",()=>s.classList.add("active")),x.on(s,"mouseleave",()=>s.classList.remove("active"))}bind(){this.invalid||this.setup_click_event()}setup_click_event(){let t=this.task.id;x.on(this.group,"mouseover",i=>{this.gantt.trigger_event("hover",[this.task,i.screenX,i.screenY,i])}),this.gantt.options.popup_on==="click"&&x.on(this.group,"mouseup",i=>{const r=i.offsetX||i.layerX;if(this.$handle_progress){const l=+this.$handle_progress.getAttribute("cx");if(l>r-1&&l<r+1||this.gantt.bar_being_dragged)return}this.gantt.show_popup({x:i.offsetX||i.layerX,y:i.offsetY||i.layerY,task:this.task,target:this.$bar})});let e;x.on(this.group,"mouseenter",i=>{e=setTimeout(()=>{this.gantt.options.popup_on==="hover"&&this.gantt.show_popup({x:i.offsetX||i.layerX,y:i.offsetY||i.layerY,task:this.task,target:this.$bar}),this.gantt.$container.querySelector(`.highlight-${t}`).classList.remove("hide")},200)}),x.on(this.group,"mouseleave",()=>{var i,r;clearTimeout(e),this.gantt.options.popup_on==="hover"&&((r=(i=this.gantt.popup)==null?void 0:i.hide)==null||r.call(i)),this.gantt.$container.querySelector(`.highlight-${t}`).classList.add("hide")}),x.on(this.group,"click",()=>{this.gantt.trigger_event("click",[this.task])}),x.on(this.group,"dblclick",i=>{this.action_completed||(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))});let s=!1;x.on(this.group,"touchstart",i=>{if(!s)return s=!0,setTimeout(function(){s=!1},300),!1;i.preventDefault(),!this.action_completed&&(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))})}update_bar_position({x:t=null,width:e=null}){const s=this.$bar;if(t){if(!this.task.dependencies.map(i=>this.gantt.get_bar(i).$bar.getX()).reduce((i,r)=>i&&t>=r,!0))return;this.update_attr(s,"x",t),this.x=t,this.$date_highlight.style.left=t+"px"}e>0&&(this.update_attr(s,"width",e),this.$date_highlight.style.width=e+"px"),this.update_label_position(),this.update_handle_position(),this.date_changed(),this.compute_duration(),this.gantt.options.show_expected_progress&&this.update_expected_progressbar_position(),this.update_progressbar_position(),this.update_arrow_position()}update_label_position_on_horizontal_scroll({x:t,sx:e}){const s=this.gantt.$container,i=this.group.querySelector(".bar-label"),r=this.group.querySelector(".bar-img")||"",l=this.bar_group.querySelector(".img_mask")||"";let o=this.$bar.getX()+this.$bar.getWidth(),d=i.getX()+t,g=r&&r.getX()+t||0,h=r&&r.getBBox().width+7||7,c=d+i.getBBox().width+7,_=e+s.clientWidth/2;i.classList.contains("big")||(c<o&&t>0&&c<_||d-h>this.$bar.getX()&&t<0&&c>_)&&(i.setAttribute("x",d),r&&(r.setAttribute("x",g),l.setAttribute("x",g)))}date_changed(){let t=!1;const{new_start_date:e,new_end_date:s}=this.compute_start_end_date();Number(this.task._start)!==Number(e)&&(t=!0,this.task._start=e),Number(this.task._end)!==Number(s)&&(t=!0,this.task._end=s),t&&this.gantt.trigger_event("date_change",[this.task,e,u.add(s,-1,"second")])}progress_changed(){this.task.progress=this.compute_progress(),this.gantt.trigger_event("progress_change",[this.task,this.task.progress])}set_action_completed(){this.action_completed=!0,setTimeout(()=>this.action_completed=!1,1e3)}compute_start_end_date(){const t=this.$bar,e=t.getX()/this.gantt.config.column_width;let s=u.add(this.gantt.gantt_start,e*this.gantt.config.step,this.gantt.config.unit);const i=t.getWidth()/this.gantt.config.column_width,r=u.add(s,i*this.gantt.config.step,this.gantt.config.unit);return{new_start_date:s,new_end_date:r}}compute_progress(){this.progress_width=this.$bar_progress.getWidth(),this.x=this.$bar_progress.getBBox().x;const t=this.x+this.progress_width,e=this.progress_width-this.gantt.config.ignored_positions.reduce((i,r)=>i+(r>=this.x&&r<=t),0)*this.gantt.config.column_width;if(e<0)return 0;const s=this.$bar.getWidth()-this.ignored_duration_raw*this.gantt.config.column_width;return parseInt(e/s*100,10)}compute_expected_progress(){this.expected_progress=u.diff(u.today(),this.task._start,"hour")/this.gantt.config.step,this.expected_progress=(this.expected_progress<this.duration?this.expected_progress:this.duration)*100/this.duration}compute_x(){const{column_width:t}=this.gantt.config,e=this.task._start,s=this.gantt.gantt_start;let i=u.diff(e,s,this.gantt.config.unit)/this.gantt.config.step*t;this.x=i}compute_y(){this.y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding)}compute_duration(){let t=0,e=0;for(let s=new Date(this.task._start);s<this.task._end;s.setDate(s.getDate()+1))e++,!this.gantt.config.ignored_dates.find(i=>i.getTime()===s.getTime())&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(s))&&t++;this.task.actual_duration=t,this.task.ignored_duration=e-t,this.duration=u.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_duration_raw=u.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_duration_raw=this.duration-this.actual_duration_raw}update_attr(t,e,s){return s=+s,isNaN(s)||t.setAttribute(e,s),t}update_expected_progressbar_position(){this.invalid||(this.$expected_bar_progress.setAttribute("x",this.$bar.getX()),this.compute_expected_progress(),this.$expected_bar_progress.setAttribute("width",this.gantt.config.column_width*this.actual_duration_raw*(this.expected_progress/100)||0))}update_progressbar_position(){this.invalid||this.gantt.options.readonly||(this.$bar_progress.setAttribute("x",this.$bar.getX()),this.$bar_progress.setAttribute("width",this.calculate_progress_width()))}update_label_position(){const t=this.bar_group.querySelector(".img_mask")||"",e=this.$bar,s=this.group.querySelector(".bar-label"),i=this.group.querySelector(".bar-img");let r=5,l=this.image_size+10;const o=s.getBBox().width,d=e.getWidth();o>d?(s.classList.add("big"),i?(i.setAttribute("x",e.getEndX()+r),t.setAttribute("x",e.getEndX()+r),s.setAttribute("x",e.getEndX()+l)):s.setAttribute("x",e.getEndX()+r)):(s.classList.remove("big"),i?(i.setAttribute("x",e.getX()+r),t.setAttribute("x",e.getX()+r),s.setAttribute("x",e.getX()+d/2+l)):s.setAttribute("x",e.getX()+d/2-o/2))}update_handle_position(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar;this.handle_group.querySelector(".handle.left").setAttribute("x",t.getX()),this.handle_group.querySelector(".handle.right").setAttribute("x",t.getEndX());const e=this.group.querySelector(".handle.progress");e&&e.setAttribute("cx",this.$bar_progress.getEndX())}update_arrow_position(){this.arrows=this.arrows||[];for(let t of this.arrows)t.update()}}class Lt{constructor(t,e,s){this.parent=t,this.popup_func=e,this.gantt=s,this.make()}make(){this.parent.innerHTML=`
            <div class="title"></div>
            <div class="subtitle"></div>
            <div class="details"></div>
            <div class="actions"></div>
        `,this.hide(),this.title=this.parent.querySelector(".title"),this.subtitle=this.parent.querySelector(".subtitle"),this.details=this.parent.querySelector(".details"),this.actions=this.parent.querySelector(".actions")}show({x:t,y:e,task:s,target:i}){this.actions.innerHTML="";let r=this.popup_func({task:s,chart:this.gantt,get_title:()=>this.title,set_title:l=>this.title.innerHTML=l,get_subtitle:()=>this.subtitle,set_subtitle:l=>this.subtitle.innerHTML=l,get_details:()=>this.details,set_details:l=>this.details.innerHTML=l,add_action:(l,o)=>{let d=this.gantt.create_el({classes:"action-btn",type:"button",append_to:this.actions});typeof l=="function"&&(l=l(s)),d.innerHTML=l,d.onclick=g=>o(s,this.gantt,g)}});r!==!1&&(r&&(this.parent.innerHTML=r),this.actions.innerHTML===""?this.actions.remove():this.parent.appendChild(this.actions),this.parent.style.left=t+10+"px",this.parent.style.top=e-10+"px",this.parent.classList.remove("hide"))}hide(){this.parent.classList.add("hide")}}function Q(a){const t=a.getFullYear();return t-t%10+""}function At(a,t,e){let s=u.add(a,6,"day"),i=s.getMonth()!==a.getMonth()?"D MMM":"D",r=!t||a.getMonth()!==t.getMonth()?"D MMM":"D";return`${u.format(a,r,e)} - ${u.format(s,i,e)}`}const L=[{name:"Hour",padding:"7d",step:"1h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,t,e)=>!t||a.getDate()!==t.getDate()?u.format(a,"D MMMM",e):"",upper_text_frequency:24},{name:"Quarter Day",padding:"7d",step:"6h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,t,e)=>!t||a.getDate()!==t.getDate()?u.format(a,"D MMM",e):"",upper_text_frequency:4},{name:"Half Day",padding:"14d",step:"12h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(a,t,e)=>!t||a.getDate()!==t.getDate()?a.getMonth()!==a.getMonth()?u.format(a,"D MMM",e):u.format(a,"D",e):"",upper_text_frequency:2},{name:"Day",padding:"7d",date_format:"YYYY-MM-DD",step:"1d",lower_text:(a,t,e)=>!t||a.getDate()!==t.getDate()?u.format(a,"D",e):"",upper_text:(a,t,e)=>!t||a.getMonth()!==t.getMonth()?u.format(a,"MMMM",e):"",thick_line:a=>a.getDay()===1},{name:"Week",padding:"1m",step:"7d",date_format:"YYYY-MM-DD",column_width:140,lower_text:At,upper_text:(a,t,e)=>!t||a.getMonth()!==t.getMonth()?u.format(a,"MMMM",e):"",thick_line:a=>a.getDate()>=1&&a.getDate()<=7,upper_text_frequency:4},{name:"Month",padding:"2m",step:"1m",column_width:120,date_format:"YYYY-MM",lower_text:"MMMM",upper_text:(a,t,e)=>!t||a.getFullYear()!==t.getFullYear()?u.format(a,"YYYY",e):"",thick_line:a=>a.getMonth()%3===0,snap_at:"7d"},{name:"Year",padding:"2y",step:"1y",column_width:120,date_format:"YYYY",upper_text:(a,t,e)=>!t||Q(a)!==Q(t)?Q(a):"",lower_text:"YYYY",snap_at:"30d"}],Mt={arrow_curve:5,auto_move_label:!1,bar_corner_radius:3,bar_height:30,container_height:"auto",column_width:null,date_format:"YYYY-MM-DD HH:mm",upper_header_height:45,lower_header_height:30,snap_at:null,infinite_padding:!0,holidays:{"var(--g-weekend-highlight-color)":"weekend"},ignore:[],language:"en",lines:"both",move_dependencies:!0,padding:18,popup:a=>{a.set_title(a.task.name),a.task.description?a.set_subtitle(a.task.description):a.set_subtitle("");const t=u.format(a.task._start,"MMM D",a.chart.options.language),e=u.format(u.add(a.task._end,-1,"second"),"MMM D",a.chart.options.language);a.set_details(`${t} - ${e} (${a.task.actual_duration} days${a.task.ignored_duration?" + "+a.task.ignored_duration+" excluded":""})<br/>Progress: ${Math.floor(a.task.progress*100)/100}%`)},popup_on:"click",readonly_progress:!1,readonly_dates:!1,readonly:!1,scroll_to:"today",show_expected_progress:!1,today_button:!0,view_mode:"Day",view_mode_select:!1,view_modes:L,is_weekend:a=>a.getDay()===0||a.getDay()===6};class st{constructor(t,e,s){this.setup_wrapper(t),this.setup_options(s),this.setup_tasks(e),this.change_view_mode(),this.bind_events()}setup_wrapper(t){let e,s;if(typeof t=="string"){let i=document.querySelector(t);if(!i)throw new ReferenceError(`CSS selector "${t}" could not be found in DOM`);t=i}if(t instanceof HTMLElement)s=t,e=t.querySelector("svg");else if(t instanceof SVGElement)e=t;else throw new TypeError("Frappe Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");e?(this.$svg=e,this.$svg.classList.add("gantt")):this.$svg=y("svg",{append_to:s,class:"gantt"}),this.$container=this.create_el({classes:"gantt-container",append_to:this.$svg.parentElement}),this.$container.appendChild(this.$svg),this.$popup_wrapper=this.create_el({classes:"popup-wrapper",append_to:this.$container})}setup_options(t){this.original_options=t,t!=null&&t.view_modes&&(t.view_modes=t.view_modes.map(s=>{if(typeof s=="string"){const i=L.find(r=>r.name===s);return i||console.error(`The view mode "${s}" is not predefined in Frappe Gantt. Please define the view mode object instead.`),i}return s}),t.view_mode=t.view_modes[0]),this.options={...Mt,...t};const e={"grid-height":"container_height","bar-height":"bar_height","lower-header-height":"lower_header_height","upper-header-height":"upper_header_height"};for(let s in e){let i=this.options[e[s]];i!=="auto"&&this.$container.style.setProperty("--gv-"+s,i+"px")}if(this.config={ignored_dates:[],ignored_positions:[],extend_by_units:10},typeof this.options.ignore!="function"){typeof this.options.ignore=="string"&&(this.options.ignore=[this.options.ignore]);for(let s of this.options.ignore){if(typeof s=="function"){this.config.ignored_function=s;continue}typeof s=="string"&&(s==="weekend"?this.config.ignored_function=i=>i.getDay()==6||i.getDay()==0:this.config.ignored_dates.push(new Date(s+" ")))}}else this.config.ignored_function=this.options.ignore}update_options(t){this.setup_options({...this.original_options,...t}),this.change_view_mode(void 0,!0)}setup_tasks(t){this.tasks=t.map((e,s)=>{if(!e.start)return console.error(`task "${e.id}" doesn't have a start date`),!1;if(e._start=u.parse(e.start),e.end===void 0&&e.duration!==void 0&&(e.end=e._start,e.duration.split(" ").forEach(i=>{let{duration:r,scale:l}=u.parse_duration(i);e.end=u.add(e.end,r,l)})),!e.end)return console.error(`task "${e.id}" doesn't have an end date`),!1;if(e._end=u.parse(e.end),u.diff(e._end,e._start,"year")<0)return console.error(`start of task can't be after end of task: in task "${e.id}"`),!1;if(u.diff(e._end,e._start,"year")>10)return console.error(`the duration of task "${e.id}" is too long (above ten years)`),!1;if(e._index=s,u.get_date_values(e._end).slice(3).every(i=>i===0)&&(e._end=u.add(e._end,24,"hour")),typeof e.dependencies=="string"||!e.dependencies){let i=[];e.dependencies&&(i=e.dependencies.split(",").map(r=>r.trim().replaceAll(" ","_")).filter(r=>r)),e.dependencies=i}return e.id?typeof e.id=="string"?e.id=e.id.replaceAll(" ","_"):e.id=`${e.id}`:e.id=Dt(e),e}).filter(e=>e),this.setup_dependencies()}setup_dependencies(){this.dependency_map={};for(let t of this.tasks)for(let e of t.dependencies)this.dependency_map[e]=this.dependency_map[e]||[],this.dependency_map[e].push(t.id)}refresh(t){this.setup_tasks(t),this.change_view_mode()}update_task(t,e){let s=this.tasks.find(r=>r.id===t),i=this.bars[s._index];Object.assign(s,e),i.refresh()}change_view_mode(t=this.options.view_mode,e=!1){typeof t=="string"&&(t=this.options.view_modes.find(r=>r.name===t));let s,i;e&&(s=this.$container.scrollLeft,i=this.options.scroll_to,this.options.scroll_to=null),this.options.view_mode=t.name,this.config.view_mode=t,this.update_view_scale(t),this.setup_dates(e),this.render(),e&&(this.$container.scrollLeft=s,this.options.scroll_to=i),this.trigger_event("view_change",[t])}update_view_scale(t){let{duration:e,scale:s}=u.parse_duration(t.step);this.config.step=e,this.config.unit=s,this.config.column_width=this.options.column_width||t.column_width||45,this.$container.style.setProperty("--gv-column-width",this.config.column_width+"px"),this.config.header_height=this.options.lower_header_height+this.options.upper_header_height+10}setup_dates(t=!1){this.setup_gantt_dates(t),this.setup_date_values()}setup_gantt_dates(t){let e,s;this.tasks.length||(e=new Date,s=new Date);for(let i of this.tasks)(!e||i._start<e)&&(e=i._start),(!s||i._end>s)&&(s=i._end);if(e=u.start_of(e,this.config.unit),s=u.start_of(s,this.config.unit),!t)if(this.options.infinite_padding)this.gantt_start=u.add(e,-this.config.extend_by_units*3,this.config.unit),this.gantt_end=u.add(s,this.config.extend_by_units*3,this.config.unit);else{typeof this.config.view_mode.padding=="string"&&(this.config.view_mode.padding=[this.config.view_mode.padding,this.config.view_mode.padding]);let[i,r]=this.config.view_mode.padding.map(u.parse_duration);this.gantt_start=u.add(e,-i.duration,i.scale),this.gantt_end=u.add(s,r.duration,r.scale)}this.config.date_format=this.config.view_mode.date_format||this.options.date_format,this.gantt_start.setHours(0,0,0,0)}setup_date_values(){let t=this.gantt_start;for(this.dates=[t];t<this.gantt_end;)t=u.add(t,this.config.step,this.config.unit),this.dates.push(t)}bind_events(){this.bind_grid_click(),this.bind_holiday_labels(),this.bind_bar_events()}render(){this.clear(),this.setup_layers(),this.make_grid(),this.make_dates(),this.make_grid_extras(),this.make_bars(),this.make_arrows(),this.map_arrows_on_bars(),this.set_dimensions(),this.set_scroll_position(this.options.scroll_to)}setup_layers(){this.layers={};const t=["grid","arrow","progress","bar"];for(let e of t)this.layers[e]=y("g",{class:e,append_to:this.$svg});this.$extras=this.create_el({classes:"extras",append_to:this.$container}),this.$adjust=this.create_el({classes:"adjust hide",append_to:this.$extras,type:"button"}),this.$adjust.innerHTML="&larr;"}make_grid(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_side_header()}make_grid_extras(){this.make_grid_highlights(),this.make_grid_ticks()}make_grid_background(){const t=this.dates.length*this.config.column_width,e=Math.max(this.config.header_height+this.options.padding+(this.options.bar_height+this.options.padding)*this.tasks.length-10,this.options.container_height!=="auto"?this.options.container_height:0);y("rect",{x:0,y:0,width:t,height:e,class:"grid-background",append_to:this.$svg}),x.attr(this.$svg,{height:e,width:"100%"}),this.grid_height=e,this.options.container_height==="auto"&&(this.$container.style.height=e+"px")}make_grid_rows(){const t=y("g",{append_to:this.layers.grid}),e=this.dates.length*this.config.column_width,s=this.options.bar_height+this.options.padding;this.config.header_height;for(let i=this.config.header_height;i<this.grid_height;i+=s)y("rect",{x:0,y:i,width:e,height:s,class:"grid-row",append_to:t})}make_grid_header(){this.$header=this.create_el({width:this.dates.length*this.config.column_width,classes:"grid-header",append_to:this.$container}),this.$upper_header=this.create_el({classes:"upper-header",append_to:this.$header}),this.$lower_header=this.create_el({classes:"lower-header",append_to:this.$header})}make_side_header(){if(this.$side_header=this.create_el({classes:"side-header"}),this.$upper_header.prepend(this.$side_header),this.options.view_mode_select){const t=document.createElement("select");t.classList.add("viewmode-select");const e=document.createElement("option");e.selected=!0,e.disabled=!0,e.textContent="Mode",t.appendChild(e);for(const s of this.options.view_modes){const i=document.createElement("option");i.value=s.name,i.textContent=s.name,s.name===this.config.view_mode.name&&(i.selected=!0),t.appendChild(i)}t.addEventListener("change",(function(){this.change_view_mode(t.value,!0)}).bind(this)),this.$side_header.appendChild(t)}if(this.options.today_button){let t=document.createElement("button");t.classList.add("today-button"),t.textContent="Today",t.onclick=this.scroll_current.bind(this),this.$side_header.prepend(t),this.$today_button=t}}make_grid_ticks(){if(this.options.lines==="none")return;let t=0,e=this.config.header_height,s=this.grid_height-this.config.header_height,i=y("g",{class:"lines_layer",append_to:this.layers.grid}),r=this.config.header_height;const l=this.dates.length*this.config.column_width,o=this.options.bar_height+this.options.padding;if(this.options.lines!=="vertical")for(let d=this.config.header_height;d<this.grid_height;d+=o)y("line",{x1:0,y1:r+o,x2:l,y2:r+o,class:"row-line",append_to:i}),r+=o;if(this.options.lines!=="horizontal")for(let d of this.dates){let g="tick";this.config.view_mode.thick_line&&this.config.view_mode.thick_line(d)&&(g+=" thick"),y("path",{d:`M ${t} ${e} v ${s}`,class:g,append_to:this.layers.grid}),this.view_is("month")?t+=u.get_days_in_month(d)*this.config.column_width/30:this.view_is("year")?t+=u.get_days_in_year(d)*this.config.column_width/365:t+=this.config.column_width}}highlight_holidays(){let t={};if(this.options.holidays)for(let e in this.options.holidays){let s=this.options.holidays[e];s==="weekend"&&(s=this.options.is_weekend);let i;if(typeof s=="object"){let r=s.find(l=>typeof l=="function");if(r&&(i=r),this.options.holidays.name){let l=new Date(s.date+" ");s=o=>l.getTime()===o.getTime(),t[l]=s.name}else s=l=>this.options.holidays[e].filter(o=>typeof o!="function").map(o=>{if(o.name){let d=new Date(o.date+" ");return t[d]=o.name,d.getTime()}return new Date(o+" ").getTime()}).includes(l.getTime())}for(let r=new Date(this.gantt_start);r<=this.gantt_end;r.setDate(r.getDate()+1))if(!(this.config.ignored_dates.find(l=>l.getTime()==r.getTime())||this.config.ignored_function&&this.config.ignored_function(r))&&(s(r)||i&&i(r))){const l=u.diff(r,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width,o=this.grid_height-this.config.header_height,d=u.format(r,"YYYY-MM-DD",this.options.language).replace(" ","_");if(t[r]){let g=this.create_el({classes:"holiday-label label_"+d,append_to:this.$extras});g.textContent=t[r]}y("rect",{x:Math.round(l),y:this.config.header_height,width:this.config.column_width/u.convert_scales(this.config.view_mode.step,"day"),height:o,class:"holiday-highlight "+d,style:`fill: ${e};`,append_to:this.layers.grid})}}}highlight_current(){const t=this.get_closest_date();if(!t)return;const[e,s]=t;s.classList.add("current-date-highlight");const i=u.diff(new Date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$current_highlight=this.create_el({top:this.config.header_height,left:i,height:this.grid_height-this.config.header_height,classes:"current-highlight",append_to:this.$container}),this.$current_ball_highlight=this.create_el({top:this.config.header_height-6,left:i-2.5,width:6,height:6,classes:"current-ball-highlight",append_to:this.$header})}make_grid_highlights(){this.highlight_holidays(),this.config.ignored_positions=[];const t=(this.options.bar_height+this.options.padding)*this.tasks.length;this.layers.grid.innerHTML+=`<pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
          <path d="M-1,1 l2,-2
                   M0,4 l4,-4
                   M3,5 l2,-2"
                style="stroke:grey; stroke-width:0.3" />
        </pattern>`;for(let e=new Date(this.gantt_start);e<=this.gantt_end;e.setDate(e.getDate()+1)){if(!this.config.ignored_dates.find(i=>i.getTime()==e.getTime())&&(!this.config.ignored_function||!this.config.ignored_function(e)))continue;let s=u.convert_scales(u.diff(e,this.gantt_start)+"d",this.config.unit)/this.config.step;this.config.ignored_positions.push(s*this.config.column_width),y("rect",{x:s*this.config.column_width,y:this.config.header_height,width:this.config.column_width,height:t,class:"ignored-bar",style:"fill: url(#diagonalHatch);",append_to:this.$svg})}this.highlight_current(this.config.view_mode)}create_el({left:t,top:e,width:s,height:i,id:r,classes:l,append_to:o,type:d}){let g=document.createElement(d||"div");for(let h of l.split(" "))g.classList.add(h);return g.style.top=e+"px",g.style.left=t+"px",r&&(g.id=r),s&&(g.style.width=s+"px"),i&&(g.style.height=i+"px"),o&&o.appendChild(g),g}make_dates(){this.get_dates_to_draw().forEach((t,e)=>{if(t.lower_text){let s=this.create_el({left:t.x,top:t.lower_y,classes:"lower-text date_"+H(t.formatted_date),append_to:this.$lower_header});s.innerText=t.lower_text}if(t.upper_text){let s=this.create_el({left:t.x,top:t.upper_y,classes:"upper-text",append_to:this.$upper_header});s.innerText=t.upper_text}}),this.upperTexts=Array.from(this.$container.querySelectorAll(".upper-text"))}get_dates_to_draw(){let t=null;return this.dates.map((e,s)=>{const i=this.get_date_info(e,t,s);return t=i,i})}get_date_info(t,e){let s=e?e.date:null;this.config.column_width;const i=e?e.x+e.column_width:0;let r=this.config.view_mode.upper_text,l=this.config.view_mode.lower_text;return r?typeof r=="string"&&(this.config.view_mode.upper_text=o=>u.format(o,r,this.options.language)):this.config.view_mode.upper_text=()=>"",l?typeof l=="string"&&(this.config.view_mode.lower_text=o=>u.format(o,l,this.options.language)):this.config.view_mode.lower_text=()=>"",{date:t,formatted_date:H(u.format(t,this.config.date_format,this.options.language)),column_width:this.config.column_width,x:i,upper_text:this.config.view_mode.upper_text(t,s,this.options.language),lower_text:this.config.view_mode.lower_text(t,s,this.options.language),upper_y:17,lower_y:this.options.upper_header_height+5}}make_bars(){this.bars=this.tasks.map(t=>{const e=new jt(this,t);return this.layers.bar.appendChild(e.group),e})}make_arrows(){this.arrows=[];for(let t of this.tasks){let e=[];e=t.dependencies.map(s=>{const i=this.get_task(s);if(!i)return;const r=new $t(this,this.bars[i._index],this.bars[t._index]);return this.layers.arrow.appendChild(r.element),r}).filter(Boolean),this.arrows=this.arrows.concat(e)}}map_arrows_on_bars(){for(let t of this.bars)t.arrows=this.arrows.filter(e=>e.from_task.task.id===t.task.id||e.to_task.task.id===t.task.id)}set_dimensions(){const{width:t}=this.$svg.getBoundingClientRect(),e=this.$svg.querySelector(".grid .grid-row")?this.$svg.querySelector(".grid .grid-row").getAttribute("width"):0;t<e&&this.$svg.setAttribute("width",e)}set_scroll_position(t){if(this.options.infinite_padding&&(!t||t==="start")){let[r,...l]=this.get_start_end_positions();this.$container.scrollLeft=r;return}if(!t||t==="start")t=this.gantt_start;else if(t==="end")t=this.gantt_end;else{if(t==="today")return this.scroll_current();typeof t=="string"&&(t=u.parse(t))}const e=u.diff(t,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$container.scrollTo({left:e-this.config.column_width/6,behavior:"smooth"}),this.$current&&this.$current.classList.remove("current-upper"),this.current_date=u.add(this.gantt_start,this.$container.scrollLeft/this.config.column_width,this.config.unit);let s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),i=this.upperTexts.find(r=>r.textContent===s);this.current_date=u.add(this.gantt_start,(this.$container.scrollLeft+i.clientWidth)/this.config.column_width,this.config.unit),s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),i=this.upperTexts.find(r=>r.textContent===s),i.classList.add("current-upper"),this.$current=i}scroll_current(){let t=this.get_closest_date();t&&this.set_scroll_position(t[0])}get_closest_date(){let t=new Date;if(t<this.gantt_start||t>this.gantt_end)return null;let e=new Date,s=this.$container.querySelector(".date_"+H(u.format(e,this.config.date_format,this.options.language))),i=0;for(;!s&&i<this.config.step;)e=u.add(e,-1,this.config.unit),s=this.$container.querySelector(".date_"+H(u.format(e,this.config.date_format,this.options.language))),i++;return[new Date(u.format(e,this.config.date_format,this.options.language)+" "),s]}bind_grid_click(){x.on(this.$container,"click",".grid-row, .grid-header, .ignored-bar, .holiday-highlight",()=>{this.unselect_all(),this.hide_popup()})}bind_holiday_labels(){const t=this.$container.querySelectorAll(".holiday-highlight");for(let e of t){const s=this.$container.querySelector(".label_"+e.classList[1]);if(!s)continue;let i;e.onmouseenter=r=>{i=setTimeout(()=>{s.classList.add("show"),s.style.left=(r.offsetX||r.layerX)+"px",s.style.top=(r.offsetY||r.layerY)+"px"},300)},e.onmouseleave=r=>{clearTimeout(i),s.classList.remove("show")}}}get_start_end_positions(){if(!this.bars.length)return[0,0,0];let{x:t,width:e}=this.bars[0].group.getBBox(),s=t,i=t,r=t+e;return Array.prototype.forEach.call(this.bars,function({group:l},o){let{x:d,width:g}=l.getBBox();d<s&&(s=d),d>i&&(i=d),d+g>r&&(r=d+g)}),[s,i,r]}bind_bar_events(){let t=!1,e=0,s=0,i=!1,r=!1,l=null,o=[];this.bar_being_dragged=null;const d=()=>t||i||r;this.$svg.onclick=h=>{h.target.classList.contains("grid-row")&&this.unselect_all()};let g=0;if(x.on(this.$svg,"mousemove",".bar-wrapper, .handle",h=>{this.bar_being_dragged===!1&&Math.abs((h.offsetX||h.layerX)-g)>10&&(this.bar_being_dragged=!0)}),x.on(this.$svg,"mousedown",".bar-wrapper, .handle",(h,c)=>{const _=x.closest(".bar-wrapper",c);c.classList.contains("left")?(i=!0,c.classList.add("visible")):c.classList.contains("right")?(r=!0,c.classList.add("visible")):c.classList.contains("bar-wrapper")&&(t=!0),this.popup&&this.popup.hide(),e=h.offsetX||h.layerX,l=_.getAttribute("data-id");let f;this.options.move_dependencies?f=[l,...this.get_all_dependent_tasks(l)]:f=[l],o=f.map(m=>this.get_bar(m)),this.bar_being_dragged=!1,g=e,o.forEach(m=>{const v=m.$bar;v.ox=v.getX(),v.oy=v.getY(),v.owidth=v.getWidth(),v.finaldx=0})}),this.options.infinite_padding){let h=!1;x.on(this.$container,"mousewheel",c=>{let _=this.$container.scrollWidth/2;if(!h&&c.currentTarget.scrollLeft<=_){let f=c.currentTarget.scrollLeft;h=!0,this.gantt_start=u.add(this.gantt_start,-this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),c.currentTarget.scrollLeft=f+this.config.column_width*this.config.extend_by_units,setTimeout(()=>h=!1,300)}if(!h&&c.currentTarget.scrollWidth-(c.currentTarget.scrollLeft+c.currentTarget.clientWidth)<=_){let f=c.currentTarget.scrollLeft;h=!0,this.gantt_end=u.add(this.gantt_end,this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),c.currentTarget.scrollLeft=f,setTimeout(()=>h=!1,300)}})}x.on(this.$container,"scroll",h=>{let c=[];const _=this.bars.map(({group:$})=>$.getAttribute("data-id"));let f;s&&(f=h.currentTarget.scrollLeft-s),this.current_date=u.add(this.gantt_start,h.currentTarget.scrollLeft/this.config.column_width*this.config.step,this.config.unit);let m=this.config.view_mode.upper_text(this.current_date,null,this.options.language),v=this.upperTexts.find($=>$.textContent===m);this.current_date=u.add(this.gantt_start,(h.currentTarget.scrollLeft+v.clientWidth)/this.config.column_width*this.config.step,this.config.unit),m=this.config.view_mode.upper_text(this.current_date,null,this.options.language),v=this.upperTexts.find($=>$.textContent===m),v!==this.$current&&(this.$current&&this.$current.classList.remove("current-upper"),v.classList.add("current-upper"),this.$current=v),s=h.currentTarget.scrollLeft;let[N,A,T]=this.get_start_end_positions();s>T+100?(this.$adjust.innerHTML="&larr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:A,behavior:"smooth"})}):s+h.currentTarget.offsetWidth<N-100?(this.$adjust.innerHTML="&rarr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:N,behavior:"smooth"})}):this.$adjust.classList.add("hide"),f&&(c=_.map($=>this.get_bar($)),this.options.auto_move_label&&c.forEach($=>{$.update_label_position_on_horizontal_scroll({x:f,sx:h.currentTarget.scrollLeft})}))}),x.on(this.$svg,"mousemove",h=>{if(!d())return;const c=(h.offsetX||h.layerX)-e;o.forEach(_=>{const f=_.$bar;f.finaldx=this.get_snap_position(c,f.ox),this.hide_popup(),i?l===_.task.id?_.update_bar_position({x:f.ox+f.finaldx,width:f.owidth-f.finaldx}):_.update_bar_position({x:f.ox+f.finaldx}):r?l===_.task.id&&_.update_bar_position({width:f.owidth+f.finaldx}):t&&!this.options.readonly&&!this.options.readonly_dates&&_.update_bar_position({x:f.ox+f.finaldx})})}),document.addEventListener("mouseup",()=>{var h,c,_;t=!1,i=!1,r=!1,(_=(c=(h=this.$container.querySelector(".visible"))==null?void 0:h.classList)==null?void 0:c.remove)==null||_.call(c,"visible")}),x.on(this.$svg,"mouseup",h=>{this.bar_being_dragged=null,o.forEach(c=>{c.$bar.finaldx&&(c.date_changed(),c.compute_progress(),c.set_action_completed())})}),this.bind_bar_progress()}bind_bar_progress(){let t=0,e=null,s=null,i=null,r=null;x.on(this.$svg,"mousedown",".handle.progress",(o,d)=>{e=!0,t=o.offsetX||o.layerX;const g=x.closest(".bar-wrapper",d).getAttribute("data-id");s=this.get_bar(g),i=s.$bar_progress,r=s.$bar,i.finaldx=0,i.owidth=i.getWidth(),i.min_dx=-i.owidth,i.max_dx=r.getWidth()-i.getWidth()});const l=this.config.ignored_positions.map(o=>[o,o+this.config.column_width]);x.on(this.$svg,"mousemove",o=>{if(!e)return;let d=o.offsetX||o.layerX;if(d>t){let h=l.find(([c,_])=>d>=c&&d<_);for(;h;)d=h[1],h=l.find(([c,_])=>d>=c&&d<_)}else{let h=l.find(([c,_])=>d>c&&d<=_);for(;h;)d=h[0],h=l.find(([c,_])=>d>c&&d<=_)}let g=d-t;console.log(i),g>i.max_dx&&(g=i.max_dx),g<i.min_dx&&(g=i.min_dx),i.setAttribute("width",i.owidth+g),x.attr(s.$handle_progress,"cx",i.getEndX()),i.finaldx=g}),x.on(this.$svg,"mouseup",()=>{e=!1,i&&i.finaldx&&(i.finaldx=0,s.progress_changed(),s.set_action_completed(),s=null,i=null,r=null)})}get_all_dependent_tasks(t){let e=[],s=[t];for(;s.length;){const i=s.reduce((r,l)=>(r=r.concat(this.dependency_map[l]),r),[]);e=e.concat(i),s=i.filter(r=>!s.includes(r))}return e.filter(Boolean)}get_snap_position(t,e){let s=1;const i=this.options.snap_at||this.config.view_mode.snap_at||"1d";if(i!=="unit"){const{duration:h,scale:c}=u.parse_duration(i);s=u.convert_scales(this.config.view_mode.step,c)/h}const r=t%(this.config.column_width/s);let l=t-r+(r<this.config.column_width/s*2?0:this.config.column_width/s),o=e+l;const d=l>0?1:-1;let g=this.get_ignored_region(o,d);for(;g.length;)o+=this.config.column_width*d,g=this.get_ignored_region(o,d),g.length||(o-=this.config.column_width*d);return o-e}get_ignored_region(t,e=1){return e===1?this.config.ignored_positions.filter(s=>t>s&&t<=s+this.config.column_width):this.config.ignored_positions.filter(s=>t>=s&&t<s+this.config.column_width)}unselect_all(){this.popup&&this.popup.parent.classList.add("hide"),this.$container.querySelectorAll(".date-range-highlight").forEach(t=>t.classList.add("hide"))}view_is(t){return typeof t=="string"?this.config.view_mode.name===t:Array.isArray(t)?t.some(view_is):this.config.view_mode.name===t.name}get_task(t){return this.tasks.find(e=>e.id===t)}get_bar(t){return this.bars.find(e=>e.task.id===t)}show_popup(t){this.options.popup!==!1&&(this.popup||(this.popup=new Lt(this.$popup_wrapper,this.options.popup,this)),this.popup.show(t))}hide_popup(){this.popup&&this.popup.hide()}trigger_event(t,e){this.options["on_"+t]&&this.options["on_"+t].apply(this,e)}get_oldest_starting_date(){return this.tasks.length?this.tasks.map(t=>t._start).reduce((t,e)=>e<=t?e:t):new Date}clear(){var t,e,s,i,r,l,o,d,g,h;this.$svg.innerHTML="",(e=(t=this.$header)==null?void 0:t.remove)==null||e.call(t),(i=(s=this.$side_header)==null?void 0:s.remove)==null||i.call(s),(l=(r=this.$current_highlight)==null?void 0:r.remove)==null||l.call(r),(d=(o=this.$extras)==null?void 0:o.remove)==null||d.call(o),(h=(g=this.popup)==null?void 0:g.hide)==null||h.call(g)}}st.VIEW_MODE={HOUR:L[0],QUARTER_DAY:L[1],HALF_DAY:L[2],DAY:L[3],WEEK:L[4],MONTH:L[5],YEAR:L[6]};function Dt(a){return a.name+"_"+Math.random().toString(36).slice(2,12)}function H(a){return a.replaceAll(" ","_").replaceAll(":","_").replaceAll(".","_")}const Y=a=>a.toISOString().split("T")[0],C=(a,t)=>{const e=new Date(a);return e.setDate(e.getDate()+t),e},Tt=a=>{if(!a.length)return[];const t=[],e=new Date;let s=new Date(e);return a.forEach((i,r)=>{const l=`phase-${r+1}`,o=i.actions||[],d=Math.max(o.length,1)*4,g=new Date(s),h=C(g,d);t.push({id:l,name:i.name||`Phase ${r+1}`,start:Y(g),end:Y(h),progress:0});let c=new Date(g);o.forEach((_,f)=>{const m=_.effortBucket==="L"?6:_.effortBucket==="M"?4:2,v=C(c,m),N=`${l}-action-${f+1}`;t.push({id:N,name:`${_.workstream||"Workstream"}: ${_.scope||"Scope TBD"}`,start:Y(c),end:Y(v),progress:0,dependencies:f===0?l:`${l}-action-${f}`}),c=C(v,1)}),s=C(h,2)}),t};function St({phases:a}){const t=w.useRef(null),e=w.useMemo(()=>Tt(a),[a]);return w.useEffect(()=>{if(!(!t.current||e.length===0))return t.current.innerHTML="",new st(t.current,e,{view_mode:"Week",bar_height:22,column_width:60,readonly:!0}),()=>{t.current&&(t.current.innerHTML="")}},[e]),n.jsxs("div",{className:"border border-slate-200 rounded-lg bg-white","data-testid":"plan-timeline",children:[n.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 px-4 py-3 border-b border-slate-200",children:n.jsxs("div",{children:[n.jsx("h3",{className:"font-semibold text-slate-900",children:"Plan Timeline"}),n.jsx("p",{className:"text-xs text-slate-500",children:"Phases and actions mapped into a lightweight Gantt view."})]})}),e.length===0?n.jsx("div",{className:"p-6 text-sm text-slate-500",children:"Generate a plan to populate the timeline."}):n.jsx("div",{className:"overflow-x-auto p-4",children:n.jsx("div",{ref:t})})]})}function Ht(){const{id:a}=ot(),[t,e]=w.useState(null),s=lt();if(w.useEffect(()=>{if(!a)return;const l=async()=>{const d=await ut(a);if(e(d),d?.status==="CREATED")try{const{isConfigured:g,getAtlanConfig:h}=await pt(async()=>{const{isConfigured:c,getAtlanConfig:_}=await import("./index-BYXjn4hA.js").then(f=>f.bn);return{isConfigured:c,getAtlanConfig:_}},__vite__mapDeps([0,1]));if(g()){const c=h();c?(console.log("[RunDashboard] Auto-triggering ingestion for CREATED run..."),await _t(a,c.baseUrl,c.apiKey)):console.warn("[RunDashboard] Atlan configured but config not available")}else console.warn("[RunDashboard] Atlan not configured - cannot auto-ingest. Please connect to Atlan first.")}catch(g){console.error("[RunDashboard] Failed to auto-trigger ingestion:",g)}};l();const o=setInterval(l,5e3);return()=>clearInterval(o)},[a]),!t)return n.jsxs("div",{className:"p-8 flex items-center gap-2",role:"status","aria-live":"polite",children:[n.jsx(K,{className:"animate-spin"}),"Loading Run..."]});const i=["CREATED","INGESTING","SCORING"].includes(t.status),r=s.pathname.split("/").pop();return n.jsxs("div",{className:"min-h-screen bg-gray-50 flex flex-col","data-testid":"run-dashboard",children:[n.jsxs("div",{className:"bg-white border-b px-4 sm:px-8 py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"text-xl font-bold",children:"Assessment Run"}),n.jsx("p",{className:"text-sm text-gray-500",children:t.id})]}),n.jsx("div",{className:"flex items-center gap-2",role:"status","aria-live":"polite","aria-label":"Run status",children:i?n.jsxs("span",{className:"flex items-center gap-2 text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-sm font-medium",children:[n.jsx(K,{className:"animate-spin",size:16}),t.status]}):n.jsxs("span",{className:"flex items-center gap-2 text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm font-medium",children:[n.jsx(ht,{size:16}),t.status]})})]}),n.jsx("div",{className:"px-4 sm:px-8 mt-6",children:n.jsx("nav",{className:"border-b","aria-label":"Run tabs",children:n.jsx("div",{className:"flex flex-wrap gap-4",role:"tablist",children:["assessment","model","plan","export"].map(l=>n.jsx(dt,{to:`/app/v2/run/${a}/${l}`,className:`pb-3 px-2 capitalize font-medium ${r===l?"border-b-2 border-blue-600 text-blue-600":"text-gray-500 hover:text-gray-700"}`,role:"tab","aria-selected":r===l,"aria-controls":`run-panel-${l}`,"data-testid":`run-tab-${l}`,children:l},l))})})}),n.jsx("div",{className:"flex-1 overflow-auto",role:"tabpanel",id:`run-panel-${r||"assessment"}`,children:n.jsx(ct,{context:{run:t}})})]})}const F=(a,t)=>t||a===null?"UNKNOWN":`${Math.round(a*100)}%`;function Yt(){const{run:a}=B(),[t,e]=w.useState(!1),[s,i]=w.useState(null),[r,l]=w.useState([]),[,o]=w.useState(!1),[d,g]=w.useState(null),[h,c]=w.useState(null),[_,f]=w.useState([]),[m,v]=w.useState([]),[N,A]=w.useState(!1),[T,$]=w.useState(null);if(!a)return null;w.useEffect(()=>{if(!a?.id)return;let p=!1;const b=async()=>{o(!0);try{const[j,D]=await Promise.all([ft(a.id).catch(()=>[]),mt(a.id).catch(()=>[])]);p||(l(j),v(D))}catch(j){console.error("Failed to fetch data",j),$(String(j))}finally{p||o(!1)}};b();const k=a.status==="COMPLETED"?null:setInterval(b,5e3);return()=>{p=!0,k&&clearInterval(k)}},[a?.id,a?.status]);const V=async p=>{if(a?.id){c(p),f([]),$(null),A(!0);try{const b=await xt(a.id,p.subjectId);f(b)}catch(b){$(String(b))}finally{A(!1)}}},M=w.useMemo(()=>{const p={};for(const b of m){const k=b.quadrant||"QUALITY_UNKNOWN";p[k]=p[k]?[...p[k],b]:[b]}return p},[m]),S=(p,b)=>{const k=(p.signals||[]).find(O=>O.signalType===b);if(!k)return"UNKNOWN";const j=k.signalValue,D=k.signalSource;return j==="UNKNOWN"||D==="NOT_OBSERVED"?"UNKNOWN":"OBSERVED"};(r||[]).map(p=>({assetQualifiedName:p.qualifiedName,assetName:p.name,assetTypeName:p.typeName,signals:{ownership:S(p,"OWNERSHIP"),semantics:S(p,"SEMANTICS"),lineage:S(p,"LINEAGE"),sensitivity:S(p,"SENSITIVITY")},impactScore:p.impactScore??null,qualityScore:p.qualityScore??null}));const it=m.length>0?m:[],at={HIGH_IMPACT_HIGH_QUALITY:"impact  50 AND quality  50",HIGH_IMPACT_LOW_QUALITY:"impact  50 AND quality < 50",LOW_IMPACT_HIGH_QUALITY:"impact < 50 AND quality  50",LOW_IMPACT_LOW_QUALITY:"impact < 50 AND quality < 50",QUALITY_UNKNOWN:"impact is UNKNOWN OR quality is UNKNOWN"},rt=d?M[d]||[]:it;if(_.map(p=>({assetQualifiedName:p.qualifiedName||"",assetName:p.name,assetTypeName:p.type,signals:{ownership:p.signals.find(b=>b.key==="ownership")?.present?"OBSERVED":"UNKNOWN",semantics:p.signals.find(b=>b.key==="semantics")?.present?"OBSERVED":"UNKNOWN",lineage:p.signals.find(b=>b.key==="lineage")?.present?"OBSERVED":"UNKNOWN",sensitivity:p.signals.find(b=>b.key==="sensitivity/access")?.present?"OBSERVED":"UNKNOWN"},impactScore:p.score?.impactScore??null,qualityScore:p.score?.qualityScore??null})),h)return n.jsxs("div",{className:"p-4 sm:p-8 space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[n.jsx("button",{onClick:()=>c(null),className:"flex items-center gap-2 text-blue-600 hover:underline font-medium","aria-label":"Back to matrix view",children:" Back to Matrix"}),n.jsxs("div",{children:[n.jsxs("h2",{className:"text-xl font-bold",children:["Domain drilldown: ",h.subjectId]}),n.jsxs("p",{className:"text-sm text-gray-500",children:["Bucket: ",h.quadrant.replace(/_/g,"  ")]})]})]}),n.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[n.jsxs("div",{className:"text-sm text-gray-600 mb-4",children:["Impact ",Math.round(h.impactScore*100),"%  Quality ",F(h.qualityScore,h.qualityUnknown),"  Assets ",h.assetCount]}),N&&n.jsx("div",{className:"text-gray-500",children:"Loading assets..."}),T&&n.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded text-red-700 text-sm",children:T}),!N&&_.length===0&&!T&&n.jsx("div",{className:"text-gray-500",children:"No assets available for this domain."}),!N&&_.length>0&&n.jsx("div",{className:"space-y-3",children:_.map(p=>n.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[n.jsxs("div",{className:"flex justify-between items-start mb-2",children:[n.jsxs("div",{children:[n.jsx("div",{className:"font-semibold",children:p.name}),n.jsx("div",{className:"text-sm text-gray-500",children:p.type}),p.qualifiedName&&n.jsx("div",{className:"text-xs text-gray-400",children:p.qualifiedName})]}),n.jsxs("div",{className:"text-right text-sm",children:[n.jsxs("div",{children:["Impact ",p.score?Math.round(p.score.impactScore*100):0,"%"]}),n.jsxs("div",{children:["Quality ",p.score?F(p.score.qualityScore,p.score.qualityUnknown):"Unknown"]}),n.jsxs("div",{className:"text-gray-500",children:["Bucket: ",p.quadrant]})]})]}),p.atlanUrl&&n.jsx("a",{href:p.atlanUrl,target:"_blank",rel:"noreferrer",className:"text-xs text-blue-600 hover:underline",children:"View in Atlan"}),n.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:p.signals.map(b=>n.jsxs("span",{className:`text-xs px-2 py-1 rounded-full border ${b.present?"bg-green-50 border-green-200":"bg-yellow-50 border-yellow-200"}`,children:[b.key,": ",b.present?"present":"UNKNOWN"]},b.key))})]},p.assetGuid))})]}),n.jsx(vt,{isOpen:t,onClose:()=>e(!1),assetQualifiedName:s?.qualifiedName||"",assetName:s?.name||"",runId:a.id})]});const I=({bucket:p,label:b,color:k,count:j,isActive:D,onClick:O})=>n.jsxs("button",{onClick:O,className:`text-left p-4 rounded-lg border transition h-32 flex flex-col justify-between
        ${k}
        ${D?"ring-2 ring-blue-500 border-blue-500":""}
      `,"aria-pressed":D,"aria-label":`Filter by ${b} (${j} domains)`,children:[n.jsx("div",{className:"text-sm font-semibold text-gray-800",children:b}),n.jsxs("div",{className:"flex justify-between items-end",children:[n.jsx("div",{className:"text-3xl font-bold text-gray-900",children:j}),n.jsx("div",{className:"text-xs text-gray-600 bg-white/50 px-2 py-1 rounded",children:at[p].replace("impact","I").replace("quality","Q")})]})]});return n.jsxs("div",{className:"p-4 sm:p-8 space-y-6",children:[n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6",children:[n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[n.jsx("div",{className:"text-sm text-gray-500",children:"Assets Scanned"}),n.jsx("div",{className:"text-3xl font-bold",children:r.length||0})]}),n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[n.jsx("div",{className:"text-sm text-gray-500",children:"Gaps Found"}),n.jsx("div",{className:"text-3xl font-bold text-amber-600",children:a.gaps?.length||0})]})]}),n.jsxs("div",{children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3",children:[n.jsx("h2",{className:"text-xl font-bold",children:"Impact  Quality Matrix (Domains)"}),d&&n.jsx("button",{className:"text-sm text-blue-600 hover:underline",onClick:()=>g(null),children:"Clear filter"})]}),n.jsxs("div",{className:"flex flex-col items-center gap-4 mb-8","data-testid":"assessment-matrix",children:[n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-3xl",children:[n.jsx(I,{bucket:"HIGH_IMPACT_LOW_QUALITY",label:"High Impact, Low Quality",color:"bg-yellow-50 border-yellow-200 hover:border-yellow-400",count:M.HIGH_IMPACT_LOW_QUALITY?.length||0,isActive:d==="HIGH_IMPACT_LOW_QUALITY",onClick:()=>g("HIGH_IMPACT_LOW_QUALITY")}),n.jsx(I,{bucket:"HIGH_IMPACT_HIGH_QUALITY",label:"High Impact, High Quality",color:"bg-green-50 border-green-200 hover:border-green-400",count:M.HIGH_IMPACT_HIGH_QUALITY?.length||0,isActive:d==="HIGH_IMPACT_HIGH_QUALITY",onClick:()=>g("HIGH_IMPACT_HIGH_QUALITY")}),n.jsx(I,{bucket:"LOW_IMPACT_LOW_QUALITY",label:"Low Impact, Low Quality",color:"bg-red-50 border-red-200 hover:border-red-400",count:M.LOW_IMPACT_LOW_QUALITY?.length||0,isActive:d==="LOW_IMPACT_LOW_QUALITY",onClick:()=>g("LOW_IMPACT_LOW_QUALITY")}),n.jsx(I,{bucket:"LOW_IMPACT_HIGH_QUALITY",label:"Low Impact, High Quality",color:"bg-blue-50 border-blue-200 hover:border-blue-400",count:M.LOW_IMPACT_HIGH_QUALITY?.length||0,isActive:d==="LOW_IMPACT_HIGH_QUALITY",onClick:()=>g("LOW_IMPACT_HIGH_QUALITY")})]}),n.jsx("div",{className:"w-full max-w-3xl",children:n.jsxs("button",{onClick:()=>g("UNKNOWN"),className:`w-full text-left p-4 rounded-lg border transition flex justify-between items-center
                  ${d==="UNKNOWN"?"border-gray-800 bg-gray-100 ring-2 ring-gray-200":"border-gray-200 bg-gray-50 hover:border-gray-400"}
                `,"aria-pressed":d==="UNKNOWN","aria-label":`Filter by unknown domains (${M.QUALITY_UNKNOWN?.length||0})`,children:[n.jsxs("div",{children:[n.jsx("div",{className:"font-semibold text-gray-700",children:"UNKNOWN (Insufficient Data)"}),n.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Impact or Quality cannot be determined"})]}),n.jsx("div",{className:"text-2xl font-bold text-gray-700",children:M.QUALITY_UNKNOWN?.length||0})]})})]})]}),n.jsxs("div",{children:[n.jsx("h2",{className:"text-xl font-bold mb-4",children:"Domain/System Scores"}),n.jsx("div",{className:"bg-white rounded-lg shadow overflow-x-auto","data-testid":"domain-score-table",children:n.jsxs("table",{className:"min-w-[720px] w-full text-left","aria-label":"Domain and system scores",children:[n.jsx("thead",{className:"bg-gray-50 border-b",children:n.jsxs("tr",{children:[n.jsx("th",{scope:"col",className:"p-4 font-medium text-gray-500",children:"Domain/System"}),n.jsx("th",{scope:"col",className:"p-4 font-medium text-gray-500",children:"Assets"}),n.jsx("th",{scope:"col",className:"p-4 font-medium text-gray-500",children:"Impact"}),n.jsx("th",{scope:"col",className:"p-4 font-medium text-gray-500",children:"Quality"}),n.jsx("th",{scope:"col",className:"p-4 font-medium text-gray-500",children:"Quadrant"})]})}),n.jsx("tbody",{className:"divide-y",children:rt.map(p=>{const b=p.subjectId||"UNKNOWN";return p.assetCount>0&&Math.round(p.knownAssetCount/p.assetCount*100),n.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>V(p),onKeyDown:k=>{(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),V(p))},role:"button",tabIndex:0,"aria-label":`View assets for ${b}`,children:[n.jsx("td",{className:"p-4 font-medium text-blue-600 hover:underline",children:b}),n.jsx("td",{className:"p-4",children:n.jsxs("div",{className:"text-sm",children:[n.jsxs("div",{children:[p.assetCount," total"]}),n.jsxs("div",{className:"text-gray-500",children:[p.knownAssetCount," with evidence"]})]})}),n.jsxs("td",{className:"p-4",children:[Math.round(p.impactScore*100),"%"]}),n.jsx("td",{className:"p-4",children:F(p.qualityScore,p.qualityUnknown)}),n.jsx("td",{className:"p-4",children:n.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${p.quadrant==="HIGH_IMPACT_HIGH_QUALITY"?"bg-green-100 text-green-700":p.quadrant==="HIGH_IMPACT_LOW_QUALITY"?"bg-yellow-100 text-yellow-700":p.quadrant==="LOW_IMPACT_HIGH_QUALITY"?"bg-blue-100 text-blue-700":p.quadrant==="LOW_IMPACT_LOW_QUALITY"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"}`,children:p.quadrant?.replace(/_/g," ")||"QUALITY UNKNOWN"})})]},p.id)})})]})})]})]})}function Ct(){const{run:a}=B(),[t,e]=w.useState([]),[s,i]=w.useState([]),[r,l]=w.useState(!1),[o,d]=w.useState(null);if(!a)return null;w.useEffect(()=>{if(!a?.id)return;const h=async()=>{try{const _=await z(a.id);_&&e(Array.isArray(_)?_:[])}catch(_){console.error("Failed to fetch plan",_)}},c=async()=>{try{const _=await J(a.id);i(Array.isArray(_)?_:[])}catch(_){console.error("Failed to fetch gaps",_)}};h(),c()},[a?.id]);const g=async()=>{if(a?.id){l(!0),d(null);try{await bt(a.id);const h=await J(a.id);i(Array.isArray(h)?h:[]),await wt(a.id);const c=await z(a.id);c&&e(Array.isArray(c)?c:[])}catch(h){d(String(h))}finally{l(!1)}}};return n.jsxs("div",{className:"p-4 sm:p-8 space-y-6",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[n.jsx("h2",{className:"text-xl font-bold",children:"Plan"}),n.jsx("button",{onClick:g,disabled:r,className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed","aria-disabled":r,"data-testid":"compute-plan",children:r?"Computing...":"Compute gaps + generate plan"})]}),o&&n.jsx("div",{className:"bg-red-50 border border-red-200 p-4 rounded text-red-700",children:o}),s.length>0&&n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[n.jsx("h3",{className:"text-lg font-bold mb-4",children:"Gaps"}),n.jsx("div",{className:"space-y-2",children:s.map(h=>n.jsxs("div",{className:"border border-gray-200 rounded p-3",children:[n.jsx("div",{className:"font-semibold text-gray-900",children:h.gapType}),n.jsx("div",{className:"text-sm text-gray-600 mt-1",children:h.explanation}),n.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Subject: ",h.subjectType," / ",h.subjectId]})]},h.id))})]}),t.length>0&&n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow","data-testid":"generated-plan",children:[n.jsx("h3",{className:"text-lg font-bold mb-4",children:"Phases"}),t.map((h,c)=>{const _=h.actions||[];return n.jsxs("div",{className:"mb-6 border border-gray-200 rounded-lg p-4",children:[n.jsx("h4",{className:"font-bold text-lg mb-3",children:h.name}),n.jsx("ul",{className:"space-y-2",children:_.map((f,m)=>n.jsxs("li",{className:"text-sm",children:[n.jsx("span",{className:"font-medium",children:f.workstream}),": ",f.scope," (effort ",f.effortBucket,")",f.explanation&&n.jsx("div",{className:"text-xs text-gray-500 mt-1 ml-4",children:f.explanation})]},m))})]},c)})]}),n.jsx(St,{phases:t})]})}function Ot(){const{run:a}=B(),[t,e]=w.useState([]),[s,i]=w.useState(!1),[r,l]=w.useState(!1),[o,d]=w.useState(null);if(!a)return null;w.useEffect(()=>{if(!a?.id)return;(async()=>{l(!0);try{const m=await Z(a.id);e(m)}catch(m){console.error("Failed to fetch artifacts",m),d(String(m))}finally{l(!1)}})()},[a?.id]);const g=async()=>{if(a?.id){i(!0),d(null);try{await yt(a.id);const f=await Z(a.id);e(f)}catch(f){console.error("Failed to generate artifacts:",f),d(String(f))}finally{i(!1)}}},h=async f=>{if(a?.id)try{const m=await tt(a.id,f);e(v=>v.map(N=>N.type===f?{...N,content:m}:N))}catch(m){console.error("Failed to load artifact content:",m)}},c=async f=>{if(a?.id)try{const m=await tt(a.id,f),v=new Blob([m],{type:"text/markdown"}),N=URL.createObjectURL(v),A=document.createElement("a");A.href=N,A.download=`${f}_${a.id}.md`,A.click(),URL.revokeObjectURL(N)}catch(m){console.error("Failed to download artifact:",m)}},_=["READINESS","MODEL","PLAN"];return n.jsxs("div",{className:"p-4 sm:p-8 space-y-6",children:[n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[n.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4",children:[n.jsx("h2",{className:"text-xl font-bold",children:"Export Artifacts"}),n.jsx("button",{onClick:g,disabled:s,className:"bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed","aria-disabled":s,"data-testid":"generate-artifacts",children:s?"Generating...":"Generate All Artifacts"})]}),o&&n.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded text-red-700 text-sm mt-4",children:o})]}),r&&n.jsx("div",{className:"text-center py-12 text-gray-500",children:"Loading artifacts..."}),!r&&t.length>0&&n.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6",children:_.map(f=>{const m=t.find(v=>v.type===f);return m?n.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h3",{className:"font-bold text-lg text-gray-900",children:f}),n.jsxs("div",{className:"flex gap-2",children:[!m.content&&n.jsx("button",{onClick:()=>h(f),className:"text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded","aria-label":`Load ${f} content`,children:"Load"}),n.jsx("button",{onClick:()=>c(f),className:"text-sm bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded text-blue-700","aria-label":`Download ${f} artifact`,children:"Download"})]})]}),m.content?n.jsx("div",{className:"h-96 overflow-auto",children:n.jsx("pre",{className:"text-xs whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded",children:m.content})}):n.jsx("div",{className:"text-sm text-gray-500",children:'Click "Load" to preview content'})]},f):null})}),!r&&t.length===0&&n.jsx("div",{className:"text-center py-12 text-gray-500",children:'No artifacts generated yet. Click "Generate All Artifacts" to create READINESS, MODEL, and PLAN exports.'})]})}function Wt(){return n.jsx(gt,{to:"assessment",replace:!0})}export{Yt as AssessmentView,Ot as ExportView,Ct as PlanView,Ht as RunDashboard,Wt as RunRoutesFallback};
